app.controller("produccionesCtrl",["$scope","$modal","$filter","produccionesService","productosService","responsablesService","AlertService",function(o,e,n,c,r,d,t){return o.alerts=[],$("#tabs a").click(function(o){o.preventDefault(),$(this).tab("show")}),o.filterProds={estado:"Retirado"},o.order=["-fecha","-id"],o.query="",o.filterSubmitted="",o.page=0,o.data=[],o.parar=!1,o.pending=!1,o.cargarProducciones=function(){o.parar||(o.parar=!0,o.pending=!0,o.page++,c.producciones(o.filterProds.estado,o.page,o.filterSubmitted).then(function(e){if(e.data.DATA.length>0){for(i=0;i<e.data.DATA.length;i++)o.data.push(e.data.DATA[i]);o.parar=!1}else o.data.length>0&&$(".finProducciones").html('<div class="fin"></div>'),o.parar=!0;o.pending=!1},function(e){o.pending=!1,t.add("danger",e.data.MSG)}))},o.filtrarProducciones=function(){o.parar=!1,o.data=[],o.page=0,o.filterSubmitted=o.query,o.cargarProducciones()},o.$watch("filterProds.estado",function(e,n){e!=n&&o.filtrarProducciones()},!0),o.infoModal={},o.openProduccion=function(i){o.infoModal.produccion=""!=i?n("getById")(o.data,i):"",angular.element("#fechaProduccion").focus();var r=e.open({templateUrl:dir_root+"/templates/producciones/addedit.html",windowClass:"wndProduccion",controller:"ModalProduccionInstanceCtrl",backdrop:"static",keyboard:!0,resolve:{info:function(){return o.infoModal}}});r.result.then(function(e){""==o.infoModal.produccion?c.addProduccion(e).then(function(n){o.data.splice(0,0,n.data.DATA),t.add("success","Se creó una nueva producción.",1e3),"print"==e.action&&o.print(n.data.DATA)},function(o){t.add("danger",o.data.MSG)}):c.editProduccion(e).then(function(c){var i=n("getIndexById")(o.data,c.data.DATA.id);o.data[i]=c.data.DATA,t.add("success","Se actualizó la información de la producción.",1e3),"print"==e.action&&o.print(c.data.DATA)},function(o){t.add("danger",o.data.MSG)})},function(i){if("delete"==i.action){var r={msj:"¿Está seguro que desea eliminar esta producción?",accept:"Si",cancel:"No"},d=i.idProduccion,a=e.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:"modalConfirmCtrl",resolve:{txt:function(){return r}}});a.result.then(function(){c.deleteProduccion(d).then(function(){var e=n("getIndexById")(o.data,d);o.data.splice(e,1)},function(o){t.add("danger",o.data.MSG)})},function(){})}})},o.nuevo=function(e){o.openProduccion("",e)},o.print=function(o){e.open({templateUrl:dir_root+"/templates/printDoc.html",windowClass:"wndPdf",controller:"modalPdfProduccionCtrl",resolve:{produccion:function(){return o}}})},$("#infinite-scrolling").size()>0?void $(window).on("scroll",function(){$(window).scrollTop()>$(document).height()-$(window).height()-60&!o.parar&!o.pending&&o.cargarProducciones()}):void 0}]),app.controller("ModalProduccionInstanceCtrl",["$scope","$modalInstance","$filter","produccionesService","productosService","responsablesService","info",function(o,e,n,c,i,r,d){if(o.estados=["Retirado","Devuelto"],$.mockjax({url:"/estados",status:200,responseTime:400,response:function(){this.responseText=o.estados}}),o.form={},o.p={},o.form.modelo={nombre:"",id:""},""!=d.produccion){var t=angular.copy(d.produccion);o.produccion=d.produccion,o.form.responsable={nombre:o.produccion.responsable,id:o.produccion.responsables_id},c.modelosProduccion(d.produccion.id).then(function(e){o.produccion.modelos=e.data.DATA},function(o){AlertService.add("danger",o.data.MSG)}),o.produccion.fecha=new Date(o.produccion.fecha).toISOString().slice(0,10),o.produccion.fecha_devolucion=new Date(o.produccion.fecha_devolucion).toISOString().slice(0,10)}else{o.produccion={fecha:(new Date).toISOString().slice(0,10),fecha_devolucion:(new Date).toISOString().slice(0,10),estado:"Retirado",responsables_id:"",responsable:"",modelos:[],motivo:"",nota:""};var t=o.produccion;o.form.responsable={nombre:"",id:""}}o.produccion.mod2delete=[],o.actionBeforeSave="",o.search=function(){""!=o.form.idModelo&&i.getProductoModelo(o.form.idModelo).then(function(e){o.form.modelo=e.data.DATA},function(n){(403==n.status||401==n.status)&&(e.dismiss({action:"cancel"}),$location.path("/index")),o.form.modelo.nombre=""})},o.searchByName=function(){""!=o.form.modelo.nombre&&i.getProductoModeloByName(o.form.modelo.nombre).then(function(e){o.p.mod_options=e.data.DATA},function(n){(403==n.status||401==n.status)&&(e.dismiss({action:"cancel"}),$location.path("/index")),o.p.mod_options=[]})},o.setModel=function(e){o.form.modelo=e,o.form.idModelo=e.id},o.searchResponsableByName=function(){""!=o.form.responsable.nombre&&r.getResponsableByName(o.form.responsable.nombre).then(function(e){o.p.resp_options=e.data.DATA},function(n){(403==n.status||401==n.status)&&(e.dismiss({action:"cancel"}),$location.path("/login")),o.p.cl_options=[]})},o.setResponsable=function(e){o.form.responsable=e,o.form.isResponsable=e.id},o.ok=function(){e.close({produccion:o.produccion,action:o.actionBeforeSave})},o.print=function(){o.actionBeforeSave="print"},o.save=function(){o.actionBeforeSave=""},o.cancel=function(){o.back2original(),e.dismiss({action:"cancel"})},o.deleteProduccion=function(){o.back2original();var n={action:"delete",idProduccion:o.produccion.id};e.dismiss(n)},o.back2original=function(){o.produccion.responsable=t.responsable,o.produccion.nota=t.nota,o.produccion.responsables_id=t.responsables_id,o.produccion.fecha=t.fecha,o.produccion.fecha_devolucion=t.fecha_devolucion,o.produccion.estado=t.estado,o.produccion.modelos=t.modelos,o.produccion.mod2delete=[]},o.$watch("form.responsable",function(){null!=o.form.responsable.id&&0!=o.form.responsable.id&&(o.produccion.responsables_id=o.form.responsable.id,o.produccion.responsable=o.form.responsable.nombre)}),o.add=function(){""!=o.form.modelo.nombre&&void 0!=o.form.modelo.nombre&&($mod={id:o.form.modelo.id,nombre:o.form.modelo.nombre,estado:"Retirado"},o.produccion.modelos.push($mod),o.form.modelo={nombre:"",id:""},angular.element("#newModId").focus(),angular.element("#newMod").val(""))},o.remove=function(e){null!=o.produccion.modelos[e].idProdMod&&o.produccion.mod2delete.push({id:o.produccion.modelos[e].idProdMod}),o.produccion.modelos.splice(e,1)},o.todosDevueltos=function(){o.produccion.modelos.forEach(function(o){o.estado="Devuelto"})}}]);