app.controller("pedidosespecialesCtrl",["$scope","$modal","pedidosespecialesService","AlertService","$filter",function(e,o,d,a,t){return e.userRole="",e.order=["-created","-id"],e.filterPedidos={estado:"Pendiente"},e.query="",e.filterSubmitted="",e.alerts=[],e.page=0,e.data=[],e.parar=!1,e.pending=!1,e.cargarPedidos=function(){e.page++,e.pending=!0,d.pedidos(e.filterPedidos.estado,e.page,e.filterSubmitted).then(function(o){if(o.data.DATA.length>0)for(i=0;i<o.data.DATA.length;i++)e.data.push(o.data.DATA[i]);else e.data.length>0&&$(".finPedidos").html('<div class="fin"></div>'),e.parar=!0;e.pending=!1},function(o){e.pending=!1,a.add("danger",o.data.MSG),$location.path("/login")})},e.cargarPedidos(),e.filtrarPedidos=function(){e.parar=!1,e.data=[],e.page=0,e.filterSubmitted=e.query,e.cargarPedidos()},e.$watch("filterPedidos.estado",function(o,d){o!=d&&e.filtrarPedidos()},!0),e.openPedido=function(i,n){e.infoModal={},e.userRole=n,e.infoModal.pedido=""!=i?t("getById")(e.data,i):"",e.infoModal.userRole=n,angular.element("#fechaPedido").focus();var r=o.open({templateUrl:dir_root+"/templates/pedidosespeciales/addedit.html",windowClass:"wndPedidoespecial",controller:"ModalPedidoespecialInstanceCtrl",backdrop:"static",keyboard:!0,resolve:{info:function(){return e.infoModal}}});r.result.then(function(o){""==e.infoModal.pedido?d.addPedido(o).then(function(o){e.data.splice(0,0,o.data.DATA),a.add("success",o.data.MSG,3e3)},function(e){a.add("danger",e.data.MSG)}):d.editPedido(o).then(function(d){var i=t("getIndexById")(e.data,o.pedido.id);e.data[i]=d.data.DATA,a.add("success","Se actualizó la información del pedido especial.",1e3)},function(e){a.add("danger",e.data.MSG)}),"print"==o.action&&e.print(o.pedido)},function(i){if("delete"==i.action){var n={msj:"¿Está seguro que desea eliminar este pedido?",accept:"Si",cancel:"No"},r=i.idPedido,l=o.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:modalConfirmCtrl,resolve:{txt:function(){return n}}});l.result.then(function(){d.deletePedido(r).then(function(){var o=t("getIndexById")(e.data,r);e.data.splice(o,1)},function(e){a.add("danger",e.data.MSG)})},function(){})}})},e.nuevo=function(o){e.userRole=o,e.openPedido("",o)},$("#infinite-scrolling").size()>0?void $(window).on("scroll",function(){$(window).scrollTop()>$(document).height()-$(window).height()-60&!e.parar&!e.pending&&e.cargarPedidos()}):void 0}]),app.controller("ModalPedidoespecialInstanceCtrl",["$scope","$modalInstance","$filter","pedidosespecialesService","clientesService","info",function(e,o,d,a,t,n){if(e.alerts=[],e.fps=[{label:"Efectivo",value:"Efectivo"},{label:"Tarjeta",value:"Tarjeta"},{label:"Cheque",value:"Cheque"},{label:"Transferencia",value:"Transferencia"}],e.sumarPagos=function(){if(void 0!=e.pedido.pagos){var o=0;for(i=0;i<e.pedido.pagos.length;i++)o+=parseFloat(e.pedido.pagos[i].monto,10);return o}},e.userRole=n.userRole,e.form={},e.p={},e.form.pago={monto:"",FP:"Efectivo",created:(new Date).toISOString().slice(0,10),bonificacion:""},e.getList=function(e){return t.list(e)},e.actionBeforeSave="",""!=n.pedido){var r=angular.copy(n.pedido);e.pedido=n.pedido,e.pedido.total=parseFloat(n.pedido.total),e.pedido.bonificacion=parseInt(e.pedido.bonificacion,10),e.pedido.fecha=new Date(e.pedido.created).toISOString().slice(0,10),e.pedido.pagos=[],"Entregado-Pago"==e.pedido.estado||"Entregado-Debe"==e.pedido.estado?e.estados=["Entregado-Pago","Entregado-Debe"]:(e.estados=["Pendiente","Terminado","Entregado-Pago","Entregado-Debe"],e.EditEnabled="admin"==e.userRole||"taller"==e.userRole),a.pagosPedido(n.pedido.id).then(function(o){e.pedido.pagos=o.data.DATA||[],e.pedido.totalPagos=e.sumarPagos()},function(e){AlertService.add("danger",e.data.MSG)}),e.form.cliente={nombre:e.pedido.cliente,id:e.pedido.clientes_id}}else e.pedido={created:formatLocalDate(),fecha_entrega:formatLocalDate(),estado:"Pendiente",total:"",clientes_id:"",cliente:"",pagos:[],bonificacion:0,FP:"",descripcion:""},e.form.cliente={nombre:"",id:""},e.EditEnabled=!0,e.estados=["Pendiente","Terminado","Entregado-Pago","Entregado-Debe"],e.pedido.totalPagos=0;e.pedido.pagos2delete=[],e.ok=function(){e.pedido.clientes_id=e.form.cliente.id,e.pedido.cliente=e.form.cliente.nombre,o.close({pedido:e.pedido,action:e.actionBeforeSave})},e.save=function(){e.actionBeforeSave=""},e.cancel=function(){void 0!=e.pedido.id&&e.back2original(),o.dismiss({action:"cancel"})},e.deletePedido=function(){e.back2original();var d={action:"delete",idPedido:e.pedido.id};o.dismiss(d)},e.back2original=function(){e.pedido.cliente=r.cliente,e.pedido.total=r.total,e.pedido.estado=r.estado,e.pedido.descripcion=r.descripcion,e.pedido.clientes_id=r.clientes_id,e.pedido.bonificacion=r.bonificacion},e.addPago=function(){""!=e.form.pago.monto&""!=e.form.pago.FP&&(e.form.pago.created=e.form.pago.created||(new Date).toISOString().slice(0,10),e.form.pago.bonificacion=e.form.pago.bonificacion||0,e.pedido.pagos.push(e.form.pago),e.pedido.totalPagos=parseFloat(e.pedido.totalPagos)+parseFloat(e.form.pago.monto),e.form.pago={monto:"",FP:"Efectivo",created:(new Date).toISOString().slice(0,10)},angular.element("#montoPago").focus(),angular.element("#montoPago").val(""),parseFloat(e.pedido.total)-e.pedido.totalPagos==0&&(e.pedido.estado="Entregado-Pago"))},e.removePago=function(o){e.pedido.totalPagos=parseInt(e.pedido.totalPagos,10)-parseInt(e.pedido.pagos[o].monto,10),null!=e.pedido.pagos[o].id&&e.pedido.pagos2delete.push({id:e.pedido.pagos[o].id}),e.pedido.pagos.splice(o,1)}}]);