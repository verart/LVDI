app.controller("ventasCtrl",["$scope","$modal","ventasService","productosService","AlertService","$filter","$location",function(o,e,a,t,d,l){return o.alerts=[],o.order=["-created","-id"],fechaHoy=formatLocalDate(),o.filterVentas={filter:"hoy"},o.totalVentas=0,o.page=0,o.data=[],o.parar=!1,o.pending=!1,o.cargarVentas=function(){desde="hoy"==o.filterVentas.filter?fechaHoy:"",conDeuda="conDeuda"==o.filterVentas.filter?1:0,o.page++,o.pending=!0,a.ventas(desde,"",conDeuda,o.page).then(function(e){if(e.data.DATA.length>0){if(lastVenta=0==o.data.length?-1:o.data[o.data.length-1].id,firstNewVenta=e.data.DATA[0].id,lastVenta==firstNewVenta){for(j=0;j<e.data.DATA[0].modelos.length;j++)lastVenta=o.data[o.data.length-1].modelos.push(e.data.DATA[0].modelos[j]);n=1}else n=0;for(i=n;i<e.data.DATA.length;i++)o.data.push(e.data.DATA[i])}else o.data.length>0&&$(".finVentas").html('<div class="fin"></div>'),o.parar=!0;o.pending=!1},function(e){o.pending=!1,$route.reload(),d.add("danger",e.data.MSG,3e3)})},o.$watch("filterVentas.filter",function(e,a){e!=a&&(o.parar=!1,o.data=[],o.page=0,o.cargarVentas())},!0),o.infoModal={},o.openVenta=function(t,n){o.infoModal.venta=""!=t?l("getById")(o.data,t):"",o.infoModal.userRole=n,angular.element("#fechaVenta").focus();var i=e.open({templateUrl:dir_root+"/templates/ventas/addedit.html",windowClass:"wndVenta",controller:"ModalVentaInstanceCtrl",backdrop:"static",keyboard:!0,resolve:{info:function(){return o.infoModal}}});i.result.then(function(e){""==o.infoModal.venta?a.addVenta(e).then(function(e){o.data.splice(0,0,e.data.DATA),o.nuevo(n)},function(o){d.add("danger",o.data.MSG,5e3)}):a.editVenta(e).then(function(a){var t=l("getIndexById")(o.data,e.venta.id);o.data[t]=a.data.DATA,d.add("success",a.data.MSG,5e3)},function(o){d.add("danger",o.data.MSG,5e3)})},function(t){if("delete"==t.action){var n={msj:"¿Está seguro que desea eliminar esta venta?",accept:"Si",cancel:"No"},i=t.idVenta,r=e.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:modalConfirmCtrl,resolve:{txt:function(){return n}}});r.result.then(function(){a.deleteVenta(i).then(function(){var e=l("getIndexById")(o.data,i);o.data.splice(e,1),d.add("success","Se eliminó la venta.",3e3)},function(o){d.add("danger",o.data.MSG,3e3)})},function(){})}})},o.nuevo=function(e){o.openVenta("",e)},o.showVenta=function(t,n){o.infoModal.venta=l("getById")(o.data,t),o.infoModal.userRole=n;var i=e.open({templateUrl:dir_root+"/templates/ventas/show.html",windowClass:"wndShowVenta",controller:"ModalVentaInstanceCtrl",backdrop:"static",keyboard:!0,resolve:{info:function(){return o.infoModal}}});i.result.then(function(){},function(t){if("delete"==t.action){var n={msj:"¿Está seguro que desea eliminar esta venta?",accept:"Si",cancel:"No"},i=t.idVenta,r=e.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:modalConfirmCtrl,resolve:{txt:function(){return n}}});r.result.then(function(){a.deleteVenta(i).then(function(){var e=l("getIndexById")(o.data,i);o.data.splice(e,1)},function(o){d.add("danger",o.data.MSG,5e3)})},function(){})}})},o.viewVenta=function(e,a,t){0==a?o.showVenta(e,t):o.openVenta(e,t)},o.openNotas=function(){angular.element("#nota").focus();e.open({templateUrl:dir_root+"/templates/ventas/notas.html",windowClass:"wndNotas",controller:"ModalNotaInstanceCtrl",backdrop:"static",keyboard:!0})},$("#infinite-scrolling").size()>0?void $(window).on("scroll",function(){$(window).scrollTop()>$(document).height()-$(window).height()-60&!o.parar&!o.pending&&o.cargarVentas()}):void 0}]),app.controller("ModalVentaInstanceCtrl",["$scope","$modalInstance","productosService","AlertService","ventasService","$filter","info","$location",function(o,e,a,t,n,d,l,r){if(o.fps=[{label:"Efectivo",value:"Efectivo"},{label:"Tarjeta",value:"Tarjeta"},{label:"Cheque",value:"Cheque"},{label:"Débito",value:"Debito"}],o.userRole=l.userRole,o.form={},o.p={},o.p.mod_options=[],o.p.dev_options=[],o.form.modelo={nombre:"",id:"",precio:""},o.form.modeloDev={nombre:"",id:"",precio:""},o.form.pago={monto:"",FP:"",created:formatLocalDate(),bonificacion:0},o.modId="",o.modName="",o.sumarPagos=function(){if(void 0!=o.venta.pagos){var e=0;for(i=0;i<o.venta.pagos.length;i++)e+=parseFloat(o.venta.pagos[i].monto,10)+parseFloat(o.venta.pagos[i].monto,10)*(parseInt(o.venta.pagos[i].bonificacion)/100);return e}},o.sumarDevoluciones=function(){if(void 0!=o.venta.devoluciones){var e=0;for(i=0;i<o.venta.devoluciones.length;i++)e+=parseFloat(o.venta.devoluciones[i].precio,10);return e}},""!=l.venta){o.venta=l.venta;var c=angular.copy(l.venta);o.venta.pagos=[],n.pagosVenta(l.venta.id).then(function(e){o.venta.pagos=e.data.DATA||[],o.venta.totalPagos=o.sumarPagos()},function(o){t.add("danger",o.data.MSG,5e3)}),o.venta.devoluciones=[],n.devolucionesVenta(l.venta.id).then(function(e){o.venta.devoluciones=e.data.DATA||[],o.venta.totalDevoluciones=o.sumarDevoluciones()},function(o){t.add("danger",o.data.MSG,5e3)})}else o.venta={created:formatLocalDate(),total:"0",nota:"",modelos:[],devoluciones:[],pagos:[],bonificacion:0,FP:null,totalPagos:0,totalDevoluciones:0,deuda:0,montoFavor:0,variosPagos:0};o.venta.mod2delete=[],o.venta.pagos2delete=[],o.venta.dev2delete=[],o.venta.variosPagos=o.venta.pagos.length>0||o.venta.deuda>0?1:0,o.back2original=function(){o.venta.created=c.created,o.venta.total=c.total,o.venta.totalDevoluciones=c.totalDevoluciones,o.venta.nota=c.nota,o.venta.FP=c.FP,o.venta.deuda=c.deuda,o.venta.montoFavor=c.montoFavor,o.venta.bonificacion=c.bonificacion,o.venta.modelos=c.modelos,o.venta.devoluciones=c.devoluciones,o.venta.mod2delete=[],o.venta.pagos2delete=[],o.venta.dev2delete=[]},o.ok=function(){1==o.venta.variosPagos&&(o.venta.FP=null),o.venta.deuda=o.venta.variosPagos*o.venta.deuda,e.close({venta:o.venta,action:""})},o.cancel=function(){void 0!=o.venta.id&&o.back2original(),e.dismiss({action:"cancel"})},o.deleteVenta=function(){e.dismiss({action:"delete",idVenta:o.venta.id})},o.search=function(){""!=o.form.idModelo&&a.getProductoModelo(o.form.idModelo).then(function(e){o.form.modelo=e.data.DATA},function(a){(403==a.status||401==a.status)&&(e.dismiss({action:"cancel"}),r.path("/index")),o.form.modelo.nombre=""})},o.searchByName=function(){""!=o.form.modelo.nombre&&a.getProductoModeloByName(o.form.modelo.nombre).then(function(e){o.p.mod_options=e.data.DATA},function(a){(403==a.status||401==a.status)&&(e.dismiss({action:"cancel"}),r.path("/index")),o.p.mod_options=[]})},o.setModel=function(e){o.form.modelo=e,o.form.idModelo=e.id},o.add=function(){void 0!=o.form.modelo.nombre&&void 0!=o.form.modelo.id&&""!=o.form.modelo.nombre&&""!=o.form.modelo.id&&(o.form.modelo.cantidad=o.form.modelo.cantidad||1,$mod={id:o.form.modelo.id,nombre:o.form.modelo.nombre,precio:o.form.modelo.precio,cantidad:1},o.venta.modelos.push($mod),o.venta.total=parseFloat(o.venta.total,10)+parseFloat(o.form.modelo.precio,10)*parseInt(o.form.modelo.cantidad,10),o.form.modelo={nombre:"",id:"",precio:"",cantidad:""},angular.element("#newModId").focus(),angular.element("#newMod").val(""),angular.element("#newModId").val(""))},o.remove=function(e){null!=o.venta.modelos[e].idVenMod&&o.venta.mod2delete.push({id:o.venta.modelos[e].idVenMod}),o.venta.total=parseFloat(o.venta.total,10)-parseFloat(o.venta.modelos[e].precio,10),o.venta.modelos.splice(e,1)},o.$watch("venta.bonificacion",function(){o.refreshTotal()}),o.$watch("venta.total",function(){o.refreshTotal()}),o.$watch("venta.montoFavor",function(){o.refreshTotal()}),o.$watch("venta.totalPagos",function(){o.refreshTotal()}),o.refreshTotal=function(){var e=""!=o.venta.montoFavor&&null!=o.venta.montoFavor?parseFloat(o.venta.montoFavor,10):0;o.venta.totalFinal=parseFloat(o.venta.total,10)-parseFloat(o.venta.totalDevoluciones,10)-e;var a=parseFloat(o.venta.totalFinal,10)*(parseFloat(o.venta.bonificacion,10)/100);o.venta.totalFinal=o.venta.totalFinal-a,void 0!=c&&0!=c.deuda?o.venta.deuda=o.venta.totalFinal-o.venta.totalPagos:void 0==c&&(o.venta.deuda=o.venta.totalFinal-o.venta.totalPagos)},o.searchDev=function(){""!=o.form.idModeloDev&&a.getProductoModelo(o.form.idModeloDev).then(function(e){o.form.modeloDev=e.data.DATA},function(a){(403==a.status||401==a.status)&&(e.dismiss({action:"cancel"}),r.path("/index")),o.form.modeloDev.nombre=""})},o.searchByNameDev=function(){""!=o.form.modeloDev.nombre&&a.getProductoModeloByName(o.form.modeloDev.nombre).then(function(e){o.p.dev_options=e.data.DATA},function(a){(403==a.status||401==a.status)&&(e.dismiss({action:"cancel"}),r.path("/index")),o.p.dev_options=[]})},o.setModelDev=function(e){o.form.modeloDev=e,o.form.idModeloDev=e.id},o.addDev=function(){void 0!=o.form.modeloDev.nombre&&void 0!=o.form.modeloDev.id&&""!=o.form.modeloDev.nombre&&""!=o.form.modeloDev.id&&($dev={id:o.form.modeloDev.id,nombre:o.form.modeloDev.nombre,precio:o.form.modeloDev.precio},o.venta.devoluciones.push($dev),o.venta.totalDevoluciones=parseFloat(o.venta.totalDevoluciones,10)+parseFloat(o.form.modeloDev.precio,10),o.form.modeloDev={nombre:"",id:"",precio:""},angular.element("#newDevId").focus(),angular.element("#newDev").val(""),angular.element("#newDevId").val(""))},o.removeDev=function(e){null!=o.venta.devoluciones[e].idDevMod&&o.venta.dev2delete.push({idDevMod:o.venta.devoluciones[e].idDevMod}),o.venta.totalDevoluciones=parseFloat(o.venta.totalDevoluciones,10)-parseFloat(o.venta.devoluciones[e].precio,10),o.venta.devoluciones.splice(e,1)},o.$watch("venta.totalDevoluciones",function(){o.refreshTotal()}),o.actualizarNota=function(){n.actualizarNota(o.venta.nota,o.venta.id).then(function(o){t.add("success",o.data.MSG,5e3)},function(o){t.add("danger",o.data.MSG)})},o.addPago=function(){""!=o.form.pago.monto&""!=o.form.pago.FP&&(o.form.pago.created=o.form.pago.created||formatLocalDate(),o.venta.pagos.push(o.form.pago),o.venta.totalPagos=parseFloat(o.venta.totalPagos)+parseFloat(o.form.pago.monto)+parseFloat(o.form.pago.monto)*(o.form.pago.bonificacion/100),angular.element("#montoPago").focus(),o.form.pago={monto:"",FP:"Efectivo",created:formatLocalDate(),bonificacion:0})},o.removePago=function(e){bonif=o.venta.pagos[e].monto*(o.venta.pagos[e].bonificacion/100),o.venta.totalPagos=parseInt(o.venta.totalPagos,10)-(parseInt(o.venta.pagos[e].monto,10)+bonif),null!=o.venta.pagos[e].id&&o.venta.pagos2delete.push({id:o.venta.pagos[e].id}),o.form.pago={monto:"",FP:"Efectivo",created:formatLocalDate(),bonificacion:0},o.venta.pagos.splice(e,1)},o.addPagoDefinitivo=function(){""!=o.form.pago.monto&""!=o.form.pago.FP&&n.addPago(o.form.pago,o.venta.id).then(function(e){o.form.pago.created=o.form.pago.created||formatLocalDate(),o.venta.pagos.push(e.data.DATA.pago),o.venta.totalPagos=parseFloat(o.venta.totalPagos)+parseFloat(o.form.pago.monto)+parseFloat(o.form.pago.monto)*(parseInt(o.form.pago.bonificacion)/100),o.form.pago={monto:"",FP:"Efectivo",created:formatLocalDate(),bonificacion:0},angular.element("#montoPago").focus()},function(o){t.add("danger",o.data.MSG)})},o.removePagoDefinitivo=function(e){null!=o.venta.pagos[e].id&&n.deletePago(o.venta.pagos[e].id).then(function(){o.venta.totalPagos=parseInt(o.venta.totalPagos,10)-(o.venta.pagos[e].monto+o.venta.pagos[e].monto*(o.venta.pagos[e].bonificacion/100)),o.form.pago={monto:"",FP:"Efectivo",created:formatLocalDate(),bonificacion:0},o.venta.pagos.splice(e,1)},function(o){t.add("danger",o.data.MSG)})}}]),app.controller("ModalNotaInstanceCtrl",["$scope","$modal","$modalInstance","notasService","AlertService",function(o,e,a,t,n){o.alerts=[],hoy=formatLocalDate(),o.nota={created:hoy,nota:""},t.notas(hoy,hoy).then(function(e){o.notas=e.data.DATA},function(o){n.add("danger",o.data.MSG)}),o.addNota=function(){""!=o.nota.nota&&(t.addNota(o.nota).then(function(e){o.notas.push(e.data.DATA)},function(o){n.add("danger",o.data.MSG)}),angular.element("#notaNota").focus(),angular.element("#notaNota").val(""))},o.removeNota=function(a){var d={msj:"¿Está seguro que desea eliminar esta nota?",accept:"Si",cancel:"No"},i=e.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:modalConfirmCtrl,resolve:{txt:function(){return d}}});i.result.then(function(){t.deleteNota(o.notas[a].id).then(function(){o.notas.splice(a,1)},function(o){n.add("danger",o.data.MSG)})},function(){})},o.salir=function(){a.close()}}]);