app.controller("pedidosdeclientesCtrl",["$scope","$modal","pedidosService","productosService","clientesPMService","AlertService","$filter","$routeParams","$location","$rootScope",function(d,o,e,a,t,i,n,l,c,r){$(window).unbind("scroll"),r.activeTab="pedidosdeclientes",d.order=["-nombre"],d.query="",d.pedido={},d.data="",d.alerts=[];var s=l.token;t.tienePermiso(s).then(function(o){d.pedido.cliente_name=o.data.DATA.nombre,d.pedido.clientesPM_id=o.data.DATA.id,d.pedido.bonificacion=o.data.DATA.bonificacion,d.pedido.fecha=formatLocalDate(),d.pedido.total=0,d.pedido.totalFinal=0,d.pedido.nota="",d.pedido.modelos=[],a.prodsPedido(s).then(function(o){d.data=o.data.DATA,d.initCantidad()},function(o){i("danger",o.data.MSG,3e3),d.data=""})},function(d){i.add("danger",d.data.MSG,3e3)}),d.initCantidad=function(){d.data.forEach(function(d){d.modelos.forEach(function(d){d.cantidad=0})})},d.add=function(o){for(var e=0;e<d.data[o].modelos.length;e++)0!=d.data[o].modelos[e].cantidad&&(m=n("getIndexById")(d.pedido.modelos,d.data[o].modelos[e].id),null!=m?d.pedido.modelos[m].cantidad=parseInt(d.pedido.modelos[m].cantidad)+parseInt(d.data[o].modelos[e].cantidad):d.pedido.modelos.push({id:d.data[o].modelos[e].id,nombre:d.data[o].nombre+"-"+d.data[o].modelos[e].nombre,precio:d.data[o].precio,cantidad:d.data[o].modelos[e].cantidad,estado:"Pendiente"}),d.pedido.total=d.pedido.total+d.data[o].modelos[e].cantidad*d.data[o].precio,d.pedido.totalFinal=parseFloat(d.pedido.total)-d.pedido.total*d.pedido.bonificacion/100,d.data[o].modelos[e].cantidad=0);i.add("success","Se agregó al pedido "+d.data[o].nombre,2e3)},d.viewPedido=function(){var a=o.open({templateUrl:dir_root+"/templates/pedidosdeclientes/pedido.html",windowClass:"wndPedido",controller:"ModalPedidodeclientesCtrl",backdrop:"static",keyboard:!0,resolve:{info:function(){return d.pedido}}});a.result.then(function(){var a={msj:"Se enviará el pedido. ¿Desea continuar?",accept:"Si",cancel:"No"},t=o.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:modalConfirmCtrl,resolve:{txt:function(){return a}}});t.result.then(function(){e.confirmarPedido(d.pedido,s).then(function(){i.add("success","El pedido fue realizado.",3e3),d.data=[]},function(o){i.add("danger",o.data.MSG),d.data=""})})},function(){})}}]),app.controller("ModalPedidodeclientesCtrl"[function(d,o,e,a,t,i,n){d.pedido=n,d.cancel=function(){o.dismiss()},d.ok=function(){o.close()},d.remove=function(o){d.pedido.total=parseFloat(d.pedido.total,10)-parseFloat(d.pedido.modelos[o].precio,10)*parseInt(d.pedido.modelos[o].cantidad,10),d.pedido.modelos.splice(o,1)},d.$watch("pedido.modelos",function(){d.refreshTotal()},!0),d.refreshTotal=function(){total=0,d.pedido.modelos.forEach(function(d){total+=d.precio*parseInt(d.cantidad)}),d.pedido.total=total}}]);