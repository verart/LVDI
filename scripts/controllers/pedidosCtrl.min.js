app.controller("pedidosCtrl",["$scope","$modal","pedidosService","productosService","clientesPMService","AlertService","$filter",function(o,e,d,t,n,a,r){return o.userRole="",o.order=["-fecha","-id"],o.filterPedidos={estado:"Pendiente"},o.query="",o.filterSubmitted="",o.alerts=[],o.page=0,o.data=[],o.parar=!1,o.pending=!1,o.cargarPedidos=function(){o.page++,o.pending=!0,d.pedidos(o.filterPedidos.estado,o.page,o.filterSubmitted).then(function(e){if(e.data.DATA.length>0)for(i=0;i<e.data.DATA.length;i++)o.data.push(e.data.DATA[i]);else o.data.length>0&&$(".finPedidos").html('<div class="fin"></div>'),o.parar=!0;o.pending=!1},function(e){o.pending=!1,a.add("danger",e.data.MSG)})},o.cargarPedidos(),o.filtrarPedidos=function(){o.parar=!1,o.data=[],o.page=0,o.filterSubmitted=o.query,o.cargarPedidos()},o.$watch("filterPedidos.estado",function(e,d){e!=d&&o.filtrarPedidos()},!0),o.infoModal={},o.openPedido=function(i,t){o.userRole=t,o.infoModal.pedido=""!=i?r("getById")(o.data,i):"",o.infoModal.userRole=t,angular.element("#fechaPedido").focus();var n=e.open({templateUrl:dir_root+"/templates/pedidos/addedit.html",windowClass:"wndPedido",controller:"ModalPedidoInstanceCtrl",backdrop:"static",keyboard:!0,resolve:{info:function(){return o.infoModal}}});n.result.then(function(e){""==o.infoModal.pedido?d.addPedido(e).then(function(e){o.data.splice(0,0,e.data.DATA),a.add("success","Se creó un nuevo pedido.",1e3)},function(o){a.add("danger",o.data.MSG)}):d.editPedido(e).then(function(d){var i=r("getIndexById")(o.data,e.pedido.id);o.data[i]=d.data.DATA,a.add("success","Se actualizó la información del pedido.",1e3)},function(o){a.add("danger",o.data.MSG)}),"print"==e.action&&o.print(e.pedido)},function(i){if("delete"==i.action){var t={msj:"¿Está seguro que desea eliminar este pedido?",accept:"Si",cancel:"No"},n=i.idPedido,l=e.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:modalConfirmCtrl,resolve:{txt:function(){return t}}});l.result.then(function(){d.deletePedido(n).then(function(){var e=r("getIndexById")(o.data,n);o.data.splice(e,1)},function(o){a.add("danger",o.data.MSG)})},function(){})}})},o.nuevo=function(e){o.userRole=e,o.openPedido("",e)},o.print=function(d){controllerPrint=""==o.userRole||"admin"==o.userRole?modalPdfPedidoCtrl:modalPdfPedidoNotAdminCtrl,n.cliente(d.clientesPM_id).then(function(o){d.datosCliente=o.data.DATA;e.open({templateUrl:dir_root+"/templates/printDoc.html",windowClass:"wndPdf",controller:controllerPrint,resolve:{pedido:function(){return d}}})},function(o){a.add("danger",o.data.MSG)})},$("#infinite-scrolling").size()>0?void $(window).on("scroll",function(){$(window).scrollTop()>$(document).height()-$(window).height()-60&!o.parar&!o.pending&&o.cargarPedidos()}):void 0}]),app.controller("ModalPedidoInstanceCtrl",["$scope","$modalInstance","$filter","pedidosService","productosService","clientesPMService","info",function(o,e,d,t,n,a,r){if(o.alerts=[],o.userRole=r.userRole,o.form={},o.p={mod_options:[],cl_options:[]},o.form.idModelo="",o.form.modelo={nombre:"",id:"",precio:"",cantidad:""},o.form.pago={monto:"",FP:"Efectivo",created:(new Date).toISOString().slice(0,10)},o.actionBeforeSave="",o.fps=[{label:"Efectivo",value:"Efectivo"},{label:"Tarjeta",value:"Tarjeta"},{label:"Cheque",value:"Cheque"},{label:"Transf. Victor",value:"Transf. Victor"},{label:"Transf. Fede",value:"Transf. Fede"}],o.estadosProductos=["Pendiente","Terminado"],$.mockjax({url:"/estadosProductos",status:200,responseTime:400,response:function(){this.responseText=o.estadosProductos}}),o.search=function(){""!=o.form.idModelo&&n.getProductoModelo(o.form.idModelo).then(function(e){o.form.modelo=e.data.DATA},function(d){(403==d.status||401==d.status)&&(e.dismiss({action:"cancel"}),$location.path("/index")),o.form.modelo.nombre=""})},o.searchByName=function(){""!=o.form.modelo.nombre&&n.getProductoModeloByName(o.form.modelo.nombre).then(function(e){o.p.mod_options=e.data.DATA},function(d){(403==d.status||401==d.status)&&(e.dismiss({action:"cancel"}),$location.path("/index")),o.p.mod_options=[]})},o.setModel=function(e){o.form.modelo=e,o.form.idModelo=e.id},o.searchClienteByName=function(){""!=o.form.cliente.nombre&&a.getClienteByName(o.form.cliente.nombre).then(function(e){o.p.cl_options=e.data.DATA},function(d){(403==d.status||401==d.status)&&(e.dismiss({action:"cancel"}),$location.path("/index")),o.p.cl_options=[]})},o.setCliente=function(e){o.form.cliente=e,o.form.idCliente=e.id,o.pedido.bonificacion=o.form.cliente.bonificacion},o.sumarPagos=function(){if(void 0!=o.pedido.pagos){var e=0;for(i=0;i<o.pedido.pagos.length;i++)e+=parseFloat(o.pedido.pagos[i].monto,10);return e}},""!=r.pedido){var l=angular.copy(r.pedido);o.pedido=r.pedido,o.pedido.bonificacion=parseInt(o.pedido.bonificacion,10),o.pedido.fecha=new Date(o.pedido.fecha).toISOString().slice(0,10),o.pedido.pagos=[],"Entregado-Pago"==o.pedido.estado||"Entregado-Debe"==o.pedido.estado?o.estados=["Entregado-Pago","Entregado-Debe"]:(o.estados=["Pendiente","Terminado","Entregado-Pago","Entregado-Debe"],o.EditEnabled="admin"==o.userRole||"taller"==o.userRole),t.modelosPedido(r.pedido.id).then(function(e){o.pedido.modelos=e.data.DATA},function(o){AlertService.add("danger",o.data.MSG)}),t.pagosPedido(r.pedido.id).then(function(e){o.pedido.pagos=e.data.DATA||[],o.pedido.totalPagos=o.sumarPagos()},function(o){AlertService.add("danger",o.data.MSG)}),o.form.cliente={nombre:o.pedido.cliente,id:o.pedido.clientesPM_id,bonificacion:"0"}}else o.pedido={fecha:(new Date).toISOString().slice(0,10),fecha_entrega:(new Date).toISOString().slice(0,10),estado:"Pendiente",total:"0",clientesPM_id:"",cliente:"",modelos:[],pagos:[],bonificacion:0,totalFinal:0,FP:"",nota:""},o.form.cliente={nombre:"",id:"",bonificacion:0},o.EditEnabled=!0,o.estados=["Pendiente","Terminado","Entregado-Pago","Entregado-Debe"],o.pedido.totalPagos=0;o.pedido.mod2delete=[],o.pedido.pagos2delete=[],o.ok=function(){e.close({pedido:o.pedido,action:o.actionBeforeSave})},o.print=function(){o.actionBeforeSave="print"},o.save=function(){o.actionBeforeSave=""},o.cancel=function(){void 0!=o.pedido.id&&o.back2original(),e.dismiss({action:"cancel"})},o.deletePedido=function(){o.back2original();var d={action:"delete",idPedido:o.pedido.id};e.dismiss(d)},o.back2original=function(){o.pedido.cliente=l.cliente,o.pedido.total=l.total,o.pedido.estado=l.estado,o.pedido.nota=l.nota,o.pedido.clientesPM_id=l.clientesPM_id,o.pedido.bonificacion=l.bonificacion,o.pedido.modelos=l.modelos,o.pedido.mod2delete=[]},o.add=function(){""!=o.form.modelo.nombre&&void 0!=o.form.modelo.nombre&&(o.form.modelo.cantidad=o.form.modelo.cantidad||1,$mod={id:o.form.modelo.id,nombre:o.form.modelo.nombre,precio:o.form.modelo.precio,cantidad:o.form.modelo.cantidad,estado:"Pendiente"},o.pedido.modelos.push($mod),o.pedido.total=parseInt(o.pedido.total,10)+parseInt(o.form.modelo.precio,10)*parseInt(o.form.modelo.cantidad,10),o.pedido.totalFinal=parseInt(o.pedido.total,10)-parseInt(o.pedido.total,10)*parseInt(o.pedido.bonificacion,10)/100,o.form.modelo={nombre:"",id:"",precio:"",cantidad:""},angular.element("#newModId").focus(),angular.element("#newMod").val(""),angular.element("#newModId").val(""))},o.remove=function(e){o.pedido.total=parseInt(o.pedido.total,10)-parseInt(o.pedido.modelos[e].precio,10)*parseInt(o.pedido.modelos[e].cantidad,10),null!=o.pedido.modelos[e].idPedMod&&o.pedido.mod2delete.push({id:o.pedido.modelos[e].idPedMod}),o.pedido.modelos.splice(e,1)},o.removeOld=function(e){o.pedido.total=parseInt(o.pedido.total,10)-parseInt(o.pedido.modelos[e].precio,10)*parseInt(o.pedido.modelos[e].cantidad,10)},o.refreshTotal=function(e){o.pedido.total=parseInt(o.pedido.total,10)+parseInt(o.pedido.modelos[e].precio,10)*parseInt(o.pedido.modelos[e].cantidad,10)},o.$watch("form.cliente",function(){null!=o.form.cliente.id&&0!=o.form.cliente.id&&(null!=o.pedido.bonificacion&&"0"==o.pedido.bonificacion&&(o.pedido.bonificacion=angular.copy(o.form.cliente.bonificacion)),o.pedido.clientesPM_id=o.form.cliente.id,o.pedido.clientesPM=o.form.cliente.nombre)}),o.$watch("pedido.bonificacion",function(){var e=parseInt(o.pedido.total,10)*(parseInt(o.pedido.bonificacion,10)/100);o.pedido.totalFinal=parseInt(o.pedido.total,10)-e}),o.$watch("pedido.total",function(){var e=parseInt(o.pedido.total,10)*(parseInt(o.pedido.bonificacion,10)/100);o.pedido.totalFinal=parseInt(o.pedido.total,10)-e}),o.$watch("pedido.estado",function(e,d){if("Terminado"==e&"Terminado"!=d)for(i=0;i<o.pedido.modelos.length;i++)o.pedido.modelos[i].estado="Terminado"}),o.$watch("pedido.modelos",function(){if(void 0!=o.pedido.modelos){var e=0;for(i=0;i<o.pedido.modelos.length;i++)e+=o.pedido.modelos[i].cantidad*o.pedido.modelos[i].precio;o.pedido.total=e}},!0),o.addPago=function(){""!=o.form.pago.monto&""!=o.form.pago.FP&&(o.form.pago.created=o.form.pago.created||(new Date).toISOString().slice(0,10),o.pedido.pagos.push(o.form.pago),o.pedido.totalPagos=parseFloat(o.pedido.totalPagos)+parseFloat(o.form.pago.monto),o.form.pago={monto:"",FP:"Efectivo",created:(new Date).toISOString().slice(0,10)},angular.element("#montoPago").focus(),angular.element("#montoPago").val(""),o.pedido.totalFinal-o.pedido.totalPagos==0&&(o.pedido.estado="Entregado-Pago"))},o.removePago=function(e){o.pedido.totalPagos=parseInt(o.pedido.totalPagos,10)-parseInt(o.pedido.pagos[e].monto,10),null!=o.pedido.pagos[e].id&&o.pedido.pagos2delete.push({id:o.pedido.pagos[e].id}),o.pedido.pagos.splice(e,1)}}]);