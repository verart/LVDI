app.controller("categoriasCtrl",["$scope","$modal","$filter","$log","AlertService","gastosService","AuthService","$location",function(a,e,t,o,n,r,i,c){a.order="-nombre",a.categoria={id:"",nombre:""},a.alerts=[],r.categorias().then(function(e){a.data=e.data.DATA},function(){i.logout(),c.path("/login")}),a.openCategoria=function(o){a.selectedCategoria=""!=o?t("getById")(a.data,o):"";var i=e.open({templateUrl:dir_root+"/templates/categorias/addedit.html",windowClass:"wndUsuarios",controller:"ModalCategoriasInstanceCtrl",backdrop:"static",keyboard:!0,resolve:{categoria:function(){return a.selectedCategoria}}});angular.element("#nombre").focus(),i.result.then(function(e){""==a.selectedCategoria?r.addCategoria(e).then(function(e){a.data.push(e.data.DATA),n.add("success","La categoría fue creada",1e3)},function(a){n.add("danger",a.data.MSG,5e3)}):r.addCategoria(e).then(function(){n.add("success","La categoría fue actualizada",1e3)},function(a){n.add("danger",a.data.MSG)})},function(){})},a.nuevo=function(){a.openCategoria("")},a.eliminarCategoria=function(o){var i={msj:"¿Está seguro que desea eliminar esta categoría?",accept:"Si",cancel:"No"},c=e.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:"modalConfirmCtrl",resolve:{txt:function(){return i}}});c.result.then(function(){r.deleteCategoria(o).then(function(){var e=t("getIndexById")(a.data,o);a.data.splice(e,1)},function(a){n.add("danger",a.data.MSG)})},function(){})}}]),app.controller("ModalCategoriasInstanceCtrl",["$scope","$modalInstance","categoria",function(a,e,t){if(""!=t){var o=angular.copy(t);a.categoria=t}else{a.categoria={nombre:""};var o=a.categoria}a.ok=function(){e.close({categoria:a.categoria})},a.cancel=function(){a.back2original(),e.dismiss()},a.back2original=function(){a.categoria.nombre=o.nombre}}]);
app.controller("clientesCtrl",["$scope","$modal","$filter","$log","AlertService","clientesService","$timeout",function(e,n,t,a,l,o){return e.order="-nombre",e.query="",e.filterSubmitted="",e.page=0,e.data=[],e.parar=!1,e.pending=!1,e.cargarClientes=function(){e.page++,e.pending=!0,o.clientes(e.page,e.filterSubmitted).then(function(n){if(n.data.DATA.length>0)for(i=0;i<n.data.DATA.length;i++)e.data.push(n.data.DATA[i]);else e.data.length>0&&$(".finClientes").html('<div class="fin"></div>'),e.parar=!0;e.pending=!1},function(n){e.pending=!1,l.add("danger",n.data.MSG),$location.path("/login")})},e.cargarClientes(),e.filtrarClientes=function(){e.parar=!1,e.data=[],e.page=0,e.filterSubmitted=e.query,e.cargarClientes()},e.openCliente=function(a){e.selectedCliente=""!=a?t("getById")(e.data,a):"",angular.element("#nombre").focus();var i=n.open({templateUrl:dir_root+"/templates/clientes/addedit.html",windowClass:"wndClientes",controller:"ModalClientesInstanceCtrl",backdrop:"static",keyboard:!0,resolve:{clientes:function(){return e.selectedCliente}}}),r=t("orderBy");i.result.then(function(n){""==e.selectedCliente?o.addCliente(n).then(function(n){lastName=e.data[e.data.length-1].nombre.toUpperCase(),newName=n.data.DATA.nombre.toUpperCase(),lastName>newName&&e.data.push(n.data.DATA),l.add("success",n.data.MSG,2e3),r(e.data,"-nombre",!1)},function(e){var n=e.data.MSG;l.add("danger",n,3e3)}):o.editCliente(n).then(function(){l.add("success","Se actualizó la información del cliente.",1e3)},function(e){l.add("danger",e.data.MSG)})},function(a){if("delete"==a.action){var i={msj:"¿Está seguro que desea eliminar este cliente?",accept:"Si",cancel:"No"},r=a.idCliente,d=n.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:"modalConfirmCtrl",resolve:{txt:function(){return i}}});d.result.then(function(){o.deleteCliente(r).then(function(){var n=t("getIndexById")(e.data,r);e.data.splice(n,1)},function(e){l.add("danger",e.data.MSG)})},function(){})}})},e.nuevo=function(){e.openCliente("")},e.exportarMails=function(){mails=[],o.getMails().then(function(e){n.open({templateUrl:dir_root+"/templates/printDoc.html",windowClass:"wndPdf",controller:"modalPdfClientesMailsCtrl",resolve:{clientes:function(){return e.data.DATA}}})},function(e){l.add("danger",e.data.MSG)})},$("#infinite-scrolling").size()>0?void $(window).on("scroll",function(){$(window).scrollTop()>$(document).height()-$(window).height()-60&!e.parar&!e.pending&&e.cargarClientes()}):void 0}]),app.controller("ModalClientesInstanceCtrl",["$scope","$modalInstance","$filter","clientes",function(e,n,t,a){if(""!=a){var i=angular.copy(a);e.clientes=a}else{e.clientes={nombre:"",email:"",nota:""};var i=e.clientes}e.ok=function(){n.close({clientes:e.clientes})},e.cancel=function(){e.back2original(),n.dismiss({action:"cancel"})},e.deleteCliente=function(){e.back2original();var t={action:"delete",idCliente:e.clientes.id};n.dismiss(t)},e.back2original=function(){e.clientes.nombre=i.nombre,e.clientes.email=i.email,e.clientes.nota=i.nota}}]);
app.controller("clientesPMCtrl",["$scope","$modal","$filter","$log","AlertService","clientesPMService","$timeout","$location",function(e,n,t,l,a,o){return e.order="-nombre",e.query="",e.filterSubmitted="",e.page=0,e.data=[],e.parar=!1,e.pending=!1,e.cargarClientes=function(){e.page++,e.pending=!0,o.clientes(e.page,e.filterSubmitted).then(function(n){if(n.data.DATA.length>0)for(i=0;i<n.data.DATA.length;i++)e.data.push(n.data.DATA[i]);else e.data.length>0&&$(".finClientes").html('<div class="fin"></div>'),e.parar=!0;e.pending=!1},function(n){e.pending=!1,e.parar=!0,a.add("danger",n.data.MSG)})},e.cargarClientes(),e.filtrarClientes=function(){e.parar=!1,e.data=[],e.page=0,e.filterSubmitted=e.query,e.cargarClientes()},e.openCliente=function(i){e.selectedCliente=""!=i?t("getById")(e.data,i):e.selectedCliente="",angular.element("#nombre").focus();var l=n.open({templateUrl:dir_root+"/templates/clientesPM/addedit.html",windowClass:"wndClientesPM",controller:"ModalClientesPMInstanceCtrl",backdrop:"static",keyboard:!0,resolve:{clientePM:function(){return e.selectedCliente}}});l.result.then(function(n){""==e.selectedCliente?o.addCliente(n).then(function(n){console.log(n.data.DATA),e.data.push(n.data.DATA),a.add("success","Se agregó un nuevo cliente por mayor.",1e3)},function(e){var n=e.data.MSG;a.add("danger",n,5e3)}):o.editCliente(n).then(function(){a.add("success","Se actualizó la información del cliente por mayor.",1e3)},function(e){a.add("danger",e.data.MSG)})},function(i){if("delete"==i.action){var l={msj:"¿Está seguro que desea eliminar este cliente?",accept:"Si",cancel:"No"},c=i.idCliente,d=n.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:"modalConfirmCtrl",resolve:{txt:function(){return l}}});d.result.then(function(){o.deleteCliente(c).then(function(){var n=t("getIndexById")(e.data,c);e.data.splice(n,1)},function(e){a.add("danger",e.data.MSG)})},function(){})}})},e.enviarmail=function(i){e.selectedCliente=t("getById")(e.data,i),angular.element("#cuerpo").focus();var l=n.open({templateUrl:dir_root+"/templates/clientesPM/mail.html",windowClass:"wndMail",controller:"ModalMailCtrl",backdrop:"static",keyboard:!0,resolve:{clientePM:function(){return e.selectedCliente}}});l.result.then(function(e){o.enviarMail(e).then(function(e){a.add("success",e.data.MSG,2e3)},function(e){a.add("danger",e.data.MSG)})},function(){})},e.nuevo=function(){e.openCliente("")},$("#infinite-scrolling").size()>0?void $(window).on("scroll",function(){$(window).scrollTop()>$(document).height()-$(window).height()-60&!e.parar&!e.pending&&e.cargarClientes()}):void 0}]),app.controller("ModalClientesPMInstanceCtrl",["$scope","$modalInstance","$filter","clientePM",function(e,n,t,i){if(""!=i){var l=angular.copy(i);e.clientePM=i}else{e.clientePM={nombre:"",local:"",tel:"",tel2:"",direccion:"",localidad:"",email:"",bonificacion:"",nota:""};var l=e.clientePM}e.ok=function(){n.close({clientesPM:e.clientePM})},e.cancel=function(){e.back2original(),n.dismiss({action:"cancel"})},e.deleteCliente=function(){console.log(e.clientePM),e.back2original();var t={action:"delete",idCliente:e.clientePM.id};n.dismiss(t)},e.back2original=function(){e.clientePM.id=l.id,e.clientePM.nombre=l.nombre,e.clientePM.local=l.local,e.clientePM.tel=l.tel,e.clientePM.tel2=l.tel2,e.clientePM.direccion=l.direccion,e.clientePM.localidad=l.localidad,e.clientePM.email=l.email,e.clientePM.bonificacion=l.bonificacion,e.clientePM.nota=l.nota}}]),app.controller("ModalMailCtrl",["$scope","$modalInstance","AlertService","clientePM",function(e,n,t,i){e.mail={cliente:i},e.mail.saludo="Hola "+e.mail.cliente.nombre+",",e.mail.cuerpo="Desde Los Vados del Isen te enviamos este link para que puedas realizar tu pedido.\n\nTené en cuenta que solo funcionará durante los próximos 7 días.",e.mail.despedida="Esperamos tu pedido. \n \n Los Vados del Isen",e.cancel=function(){n.dismiss()},e.ok=function(){n.close({idCliente:e.mail.cliente.id,saludo:e.mail.saludo,texto:e.mail.cuerpo,despedida:e.mail.despedida})}}]);
app.controller("colaImpresionCtrl",["$scope","$modal","$filter","$log","AlertService","colaImpresionService","productosService","$location","$window","$timeout","Session",function(e,o,t,d,a,n,i,s,r,l,u){n.impresiones(u.getUserId()).then(function(o){e.data=o.data.DATA},function(){}),e.mod_options=[],e.modelo={nombre:"",id:"",precio:"",cantidad:""},e.deleteImpresion=function(d){var i={msj:"¿Está seguro que desea eliminar este producto de la cola de impresión?",accept:"Si",cancel:"No"},c=o.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:"modalConfirmCtrl",resolve:{txt:function(){return i}}});c.result.then(function(){n.deleteImpresion(d).then(function(){var o=t("getIndexById")(e.data,d);e.data.splice(o,1)},function(e){a.add("danger",e.data.MSG)})},function(){})},e.searchByName=function(){""!=e.form.modelo.nombre&&i.getProductoModeloByName(e.form.modelo.nombre).then(function(o){e.mod_options=o.data.DATA},function(o){(403==o.status||401==o.status)&&($modalInstance.dismiss({action:"cancel"}),s.path("/index")),e.mod_options=[]})},e.setModel=function(o){e.modelo=o},e.add=function(){""!=e.modelo.nombre&&n.addModeloImpresion({modelos_id:e.modelo.id,belongsTo:u.getUserId()}).then(function(o){e.data.sueltos.modelos.push({nombre:e.modelo.nombre,modelos_id:e.modelo.id,precio:e.modelo.precio,id:o.data.DATA.id}),angular.element("#newMod").val(""),angular.element("#newMod").focus()},function(e){a.add("danger",e.data.MSG)})},e.removeProducto=function(o,t,d){n.deleteModeloImpresion(o).then(function(){switch(d){case"reposicion":e.data.reposicion.modelos.splice(t,1);case"sueltos":e.data.sueltos.modelos.splice(t,1)}},function(e){a.add("danger",e.data.MSG)})},e.removeFromPedidos=function(o,t,d){n.deleteModeloImpresion(o).then(function(){1==e.data.pedidos[t].productos.length?e.data.pedidos.splice(t,1):e.data.pedidos[t].productos.splice(d,1)},function(e){a.add("danger",e.data.MSG)})},e.removeFromProducciones=function(o,t,d){n.deleteModeloImpresion(o).then(function(){1==e.data.producciones[t].productos.length?e.data.producciones.splice(t,1):e.data.producciones[t].productos.splice(d,1)},function(e){a.add("danger",e.data.MSG)})},e.vaciarCola=function(t,d){var i;switch(t){case"reposicion":i={msj:"Se eliminarán todos los productos de la cola de impresión de resposición. ¿Desea continuar?",accept:"Si",cancel:"No"};break;case"sueltos":i={msj:"Se eliminarán todos los productos de su cola de impresión. ¿Desea continuar?",accept:"Si",cancel:"No"};break;case"producciones":i={msj:"Se eliminará la cola de impresión de la producción de "+e.data.producciones[d].responsable+". ¿Desea continuar?",accept:"Si",cancel:"No"};break;case"ventas":i={msj:"Se eliminará la cola de impresión de las devoluciones en ventas. ¿Desea continuar?",accept:"Si",cancel:"No"};break;default:i={msj:"Se eliminará la cola de impresión del pedido de "+e.data.pedidos[d].clientePM+". ¿Desea continuar?",accept:"Si",cancel:"No"}}var c=o.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:"modalConfirmCtrl",resolve:{txt:function(){return i}}});c.result.then(function(){switch(t){case"reposicion":e.data.reposicion.modelos.forEach(function(e){n.deleteModeloImpresion(e.id).then(function(){},function(e){a.add("danger",e.data.MSG)})}),e.data.reposicion.modelos=[];break;case"sueltos":e.data.sueltos.modelos.forEach(function(e){n.deleteModeloImpresion(e.id).then(function(){},function(e){a.add("danger",e.data.MSG)})}),e.data.sueltos.modelos=[];break;case"ventas":e.data.ventas.modelos.forEach(function(e){n.deleteModeloImpresion(e.id).then(function(){},function(e){a.add("danger",e.data.MSG)})}),e.data.ventas.modelos=[];break;case"producciones":var o=!1,i=e.data.producciones[d].modelos;i.every(function(){return n.deleteModeloImpresionProduccion(e.data.producciones[d].producciones_id).then(function(){},function(e){a.add("danger",e.data.MSG),o=!0}),o===!1}),e.data.producciones.splice(d,1);break;default:var o=!1,i=e.data.pedidos[d].productos;i.every(function(){return n.deleteModeloImpresionPedido(e.data.pedidos[d].pedidos_id).then(function(){},function(e){a.add("danger",e.data.MSG),o=!0}),o===!1}),e.data.pedidos.splice(d,1)}},function(){})},e.imprimir=function(o,t){"reposicion"==o||"sueltos"==o||"ventas"==o?(productosAImprimir="reposicion"==o?e.data.reposicion.modelos:"sueltos"==o?e.data.sueltos.modelos:e.data.ventas.modelos,e.imprimirEtiquetasBarcode(productosAImprimir)):"producciones"==o?(productosAImprimir=e.data.producciones[t].modelos,e.imprimirEtiquetasBarcode(productosAImprimir)):e.imprimirPedido(t)},e.imprimirEtiquetasBarcode=function(e){var o,t=0;$("#codes").empty(),e.length>0&&(style={barWidth:1,barHeight:21,fontSize:8},e.forEach(function(e){for(var d=e.modelos_id,a=d.length,n=7-a,i=0;n>i;i++)d="0"+d;bcdiv=document.createElement("div"),bcdiv.setAttribute("id","bcTarget"+t),bcdiv.setAttribute("class","etiqueta"),$("#codes").append(bcdiv),o=document.createElement("div"),o.setAttribute("id","bc"+t),o.setAttribute("class","bc"),p=document.createElement("p"),p.setAttribute("id","prod"+t),p.setAttribute("class","nombre"),e.nombre.length>52&&p.setAttribute("class","nombreChico"),pr=document.createElement("p"),pr.setAttribute("class","precio"),pr.setAttribute("id","prec"+t),$("#bcTarget"+t).append(o),$("#bcTarget"+t).append(p),$("#bcTarget"+t).append(pr),$("#prec"+t).text("$"+e.precio),$("#bc"+t).barcode({code:d,crc:!1},"int25",style),$("#prod"+t++).text(e.nombre),salto=document.createElement("div"),salto.setAttribute("class","saltopagina"),$("#codes").append(salto)}),$("#codes :last-child").last().remove(),r.print())},e.imprimirPedido=function(o){if($("#codes").empty(),e.data.pedidos[o].productos.length>0){var t=0;e.data.pedidos[o].productos.forEach(function(e){bcdiv=document.createElement("div"),bcdiv.setAttribute("id","bcTarget"+t),bcdiv.setAttribute("class","etiqueta"),$("#codes").append(bcdiv),p=document.createElement("p"),p.setAttribute("class","nombrePedido"),p.setAttribute("id","prod"+t),c=document.createElement("p"),c.setAttribute("class","cantidadPedido"),c.setAttribute("id","cant"+t),$("#bcTarget"+t).append(p),$("#bcTarget"+t).append(c),$("#prod"+t).text(e.nombre),$("#cant"+t++).text(" x "+e.cantidad),salto=document.createElement("div"),salto.setAttribute("class","saltopagina"),$("#codes").append(salto)}),$("#codes :last-child").last().remove(),r.print()}}}]);
app.controller("gastosCtrl",["$scope","$modal","gastosService","AlertService","$filter","AuthService","$location",function(t,a,e,o,n,i,r){t.alerts=[],hoy=formatLocalDate(),t.fps=[{label:"Efectivo",value:"Efectivo"},{label:"Tarjeta",value:"Tarjeta"},{label:"Cheque",value:"Cheque"},{label:"Débito",value:"Debito"},{label:"Transferencia",value:"Transferencia"}],t.gasto={created:hoy,descripcion:"",monto:"",FP:"Efectivo"},t.desde=hoy,t.hasta=hoy,t.cat_options=[],t.catFilter_options=[],t.categoria={id:"",nombre:""},t.categoriaFilter_id="",t.cargar=function(){e.gastos(t.desde,t.hasta,t.categoriaFilter_id).then(function(a){t.gastos=a.data.DATA},function(){i.logout(),r.path("/login")})},t.searchCategoriaFilterByName=function(){""!=t.categoriaFilter.nombre&&e.getCategoriasByName(t.categoriaFilter.nombre).then(function(a){t.catFilter_options=a.data.DATA},function(a){(403==a.status||401==a.status)&&r.path("/login"),t.catFilter_options=[]})},t.setCategoriaFilter=function(a){t.categoriaFilter_id=a.id},t.searchCategoriaByName=function(){""!=t.categoria.nombre&&e.getCategoriasByName(t.categoria.nombre).then(function(a){t.cat_options=a.data.DATA},function(a){(403==a.status||401==a.status)&&r.path("/login"),t.cat_options=[]})},t.setCategoria=function(a){t.gasto.categoria=a},t.addGasto=function(){""!=t.gasto.categoria&""!=t.gasto.monto?e.addGasto(t.gasto).then(function(a){t.gastos.splice(0,0,a.data.DATA),angular.element("#monto").focus(),angular.element("#descripcion").val(""),angular.element("#monto").val(""),angular.element("#categoria").val(""),t.gasto={created:hoy,descripcion:"",monto:"",FP:"Efectivo",categoria:""}},function(t){o.add("danger",t.data.MSG)}):o.add("danger","Debe completar los datos del gasto.",1e3)},t.removeGasto=function(n){var i={msj:"¿Está seguro que desea eliminar este gasto?",accept:"Si",cancel:"No"},r=a.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:"modalConfirmCtrl",resolve:{txt:function(){return i}}});r.result.then(function(){e.deleteGasto(t.gastos[n].id).then(function(){t.gastos.splice(n,1)},function(t){o.add("danger",t.data.MSG)})},function(){})},t.cargar()}]);
app.controller("ApplicationController",["$scope","$rootScope","USER_ROLES","AUTH_EVENTS","AuthService","Session","$location","$interval",function(o,t,n,e,i,a,c,r){o.usuario=a,o.stop=r(function(){var o=document.getElementById("logo");o.src="img/LVDI_s.png?rand="+Math.random()},9e5),t.activeTab=c.$$path.replace("/",""),t.$on(e.notAuthorized,function(){console.log("No autorizado"),o.logout()}),t.$on(e.notAuthenticated,function(){console.log("No autenticado"),o.logout()}),void 0==o.usuario&&(a.destroy(),o.stop=void 0),o.logout=function(){a.destroy(),i.logout(),o.stop=void 0,c.path("/login")},o.refreshActiveTab=function(o){t.activeTab=o}}]),app.controller("loginCtrl",["$scope","$rootScope","$location","AUTH_EVENTS","AuthService","Session",function(o,t,n,e,i,a){o.credentials={usuario:"",clave:"",aviso:""},o.login=function(c){i.login(c).then(function(){t.$broadcast(e.loginSuccess),"cuentas"==a.getUserRole()?(n.path("/resumen"),t.activeTab="resumen"):(n.path("/productos"),t.activeTab="productos")},function(i){t.$broadcast(e.loginFailed),o.aviso=i.data.MSG,n.path("/login")})}}]);
app.controller("modalConfirmCtrl",["$scope","$modalInstance","txt",function(c,t,n){c.msj=n.msj,c.accept_txt=n.accept,c.cancel_txt=n.cancel,c.ok=function(){t.close()},c.cancel=function(){t.dismiss()}}]);
app.controller("modalPdfClientesMailsCtrl",["$scope","$modalInstance","$sce","$filter","clientes",function(e,t,o,i,n){var a=new jsPDF("portrait","mm","a4");a.setFont("helvetica"),pageHeight=a.internal.pageSize.height,pageHeight-=25,a.setFontSize(20),a.text(10,18,"Mails de clientes"),a.setTextColor(0,0,0),a.setLineWidth(.3),a.line(10,26,200,26),row=35,a.setFontSize(11),n.forEach(function(e){row+=5,a.text(25,row,e.email),row+=3,row+5>=pageHeight&&(a.addPage(),row=20,a.setFontSize(11),a.setFontType("normal"))});var r=o.trustAsResourceUrl(a.output("datauristring"));e.pdfOutput=r,e.ok=function(){t.close()}}]);
app.controller("modalPdfPedidoCtrl",["$scope","$modalInstance","$sce","$filter","pedido",function(t,e,o,r,n){var i=new jsPDF("portrait","mm","a4");i.setFont("helvetica"),i.setFontSize(18),i.text(13,19,"Los Vados del Isen"),i.setFontSize(9),i.setTextColor(100),i.text(13,24,"Dirección: Araoz 2918 - Capital Federal"),i.text(13,28,"Tel: 4802-8969"),i.text(13,32,"Mail: losvadosdelisen@hotmail.com"),row=32,i.setTextColor(0,0,0),i.setLineWidth(.3),i.line(10,36,200,36),row+=17,i.setFontSize(12),i.setFontType("bold"),i.text(15,row,"Cliente: "),i.setFontType("normal"),i.text(33,row,n.datosCliente.nombre),i.setFontType("bold"),i.text(120,row,"Fecha de entrega: "),i.setFontType("normal"),i.text(160,row,r("date")(n.fecha_entrega,"dd/MM/yyyy")||"Sin datos"),i.setFontType("bold"),row+=6,i.setFontSize(10),i.text(15,row,"Localidad: "),i.setFontType("normal"),i.text(37,row,n.datosCliente.localidad||"Sin datos"),row+=10,i.setLineWidth(.1),i.setDrawColor(100,100,100),i.line(21,row,190,row),i.setFontSize(11),i.setFontType("bold"),row+=5,i.text(25,row,"Descripción"),i.text(130,row,"Cant."),i.text(150,row,"P. Unit."),i.text(170,row,"P. Tot."),row+=3,i.line(21,row,190,row),pageHeight=i.internal.pageSize.height,pageHeight-=25,i.setLineWidth(.05),i.setDrawColor(200),i.setFontSize(11),i.setFontType("normal"),n.modelos.forEach(function(t){row+=5;var e=t.precio*t.cantidad;i.text(25,row,t.nombre),i.text(132,row,t.cantidad.toString()),i.text(150,row,r("currency")(t.precio)),i.text(170,row,r("currency")(e.toString())),row+=3,i.line(21,row,190,row),row+5>=pageHeight&&(i.addPage(),row=20,i.setLineWidth(.05),i.setDrawColor(200),i.setFontSize(11),i.setFontType("normal"))}),row+28>=pageHeight&&(i.addPage(),row=20),row+=12,i.setFontType("bold"),i.text(25,row,"Subtotal: "),i.setFontType("normal"),i.text(50,row,r("currency")(n.total)),row+=7,i.setFontType("bold"),i.text(25,row,"Bonif. : "),i.text(50,row,n.bonificacion.toString()+"%"),row+=3,i.setDrawColor(0),i.line(23,row,90,row),i.setFontSize(13);var a=n.total*n.bonificacion/100,l=n.total-a;row+=6,i.setFontType("bold"),i.text(25,row,"Total: "),i.text(50,row,r("currency")(l.toString()));var s=o.trustAsResourceUrl(i.output("datauristring"));t.pdfOutput=s,t.ok=function(){e.close()}}]);
app.controller("modalPdfPedidoNotAdminCtrl",["$scope","$modalInstance","$sce","$filter","pedido",function(e,t,o,r,n){var a=new jsPDF("portrait","mm","a4");a.setFont("helvetica"),a.setFontSize(18),a.text(13,19,"Los Vados del Isen"),a.setFontSize(9),a.setTextColor(100),a.text(13,24,"Dirección: Araoz 2918 - Capital Federal"),a.text(13,28,"Tel: 4802-8969"),a.text(13,32,"Mail: losvadosdelisen@hotmail.com"),row=32,a.setTextColor(0,0,0),a.setLineWidth(.3),a.line(10,36,200,36),row+=17,a.setFontSize(12),a.setFontType("bold"),a.text(15,row,"Cliente: "),a.setFontType("normal"),a.text(33,row,n.datosCliente.nombre),a.setFontType("bold"),a.text(120,row,"Fecha de entrega: "),a.setFontType("normal"),a.text(160,row,r("date")(n.fecha_entrega,"dd/MM/yyyy")||"Sin datos"),a.setFontType("bold"),row+=6,a.setFontSize(10),a.text(15,row,"Localidad: "),a.setFontType("normal"),a.text(37,row,n.datosCliente.localidad||"Sin datos"),row+=10,a.setLineWidth(.1),a.setDrawColor(100,100,100),a.line(21,row,190,row),a.setFontSize(11),a.setFontType("bold"),row+=5,a.text(25,row,"Descripción"),a.text(130,row,"Cant."),row+=3,a.line(21,row,190,row),pageHeight=a.internal.pageSize.height,pageHeight-=25,a.setLineWidth(.05),a.setDrawColor(200),a.setFontSize(11),a.setFontType("normal"),n.modelos.forEach(function(e){row+=5;e.precio*e.cantidad;a.text(25,row,e.nombre),a.text(132,row,e.cantidad.toString()),row+=3,a.line(21,row,190,row),row+5>=pageHeight&&(a.addPage(),row=20,a.setLineWidth(.05),a.setDrawColor(200),a.setFontSize(11),a.setFontType("normal"))}),row+28>=pageHeight&&(a.addPage(),row=20);var i=o.trustAsResourceUrl(a.output("datauristring"));e.pdfOutput=i,e.ok=function(){t.close()}}]);
app.controller("modalPdfProduccionCtrl",["$scope","$modalInstance","$sce","produccion",function(e,t,o,n){var s=new jsPDF("Portrait","mm","a4");s.setFont("helvetica"),pageHeight=s.internal.pageSize.height,pageHeight-=25,s.setFontSize(18),s.text(13,20,"Los Vados del Isen"),s.setFontSize(10),s.text(13,27,"Dirección: Araoz 2918 - Capital Federal"),s.text(13,32,"Tel: 4802-8969"),s.text(13,37,"Mail: losvadosdelisen@hotmail.com"),s.line(13,40,200,39),s.setFontSize(14),s.text(15,52,"Producción");var a=60;s.setFontSize(11),s.setFontType("bold"),s.text(17,a,"Fecha devolución: "),s.setFontType("normal"),s.text(54,a,n.fecha_devolucion),s.setFontType("bold"),s.text(88,a,"Fecha:"),s.setFontType("normal"),s.text(102,a,n.fecha),a+=7,s.setFontType("bold"),s.text(17,a,"Responsable: "),s.setFontType("normal"),s.text(44,a,n.responsable),a+=7,s.setFontType("bold"),s.text(17,a,"Motivo: "),s.setFontType("normal"),s.text(33,a,n.motivo),a+=10,s.setLineWidth(.1),s.setDrawColor(100,100,100),s.line(24,a,190,a),s.setFontSize(11),s.setFontType("bold"),a+=5,s.text(25,a,"Detalle"),a+=3,s.line(24,a,190,a),s.setLineWidth(.05),s.setDrawColor(200),s.setFontSize(11),s.setFontType("normal"),n.modelos.forEach(function(e){a+=5,s.text(25,a,e.nombre),s.text(140,a,"$"+e.precio),a+=3,s.line(24,a,190,a),a+7>=pageHeight&&(s.addPage(),a=20,s.setLineWidth(.05),s.setDrawColor(200),s.setFontSize(11),s.setFontType("normal"))});var i=o.trustAsResourceUrl(s.output("datauristring"));e.pdfOutput=i,e.ok=function(){t.close()}}]);
app.controller("pedidosCtrl",["$scope","$modal","pedidosService","productosService","clientesPMService","AlertService","$filter",function(o,e,d,t,n,a,r){return o.userRole="",o.order=["-fecha","-id"],o.filterPedidos={estado:"Pendiente"},o.query="",o.filterSubmitted="",o.alerts=[],o.page=0,o.data=[],o.parar=!1,o.pending=!1,o.cargarPedidos=function(){o.page++,o.pending=!0,d.pedidos(o.filterPedidos.estado,o.page,o.filterSubmitted).then(function(e){if(e.data.DATA.length>0)for(i=0;i<e.data.DATA.length;i++)o.data.push(e.data.DATA[i]);else o.data.length>0&&$(".finPedidos").html('<div class="fin"></div>'),o.parar=!0;o.pending=!1},function(e){o.pending=!1,a.add("danger",e.data.MSG)})},o.cargarPedidos(),o.filtrarPedidos=function(){o.parar=!1,o.data=[],o.page=0,o.filterSubmitted=o.query,o.cargarPedidos()},o.$watch("filterPedidos.estado",function(e,d){e!=d&&o.filtrarPedidos()},!0),o.infoModal={},o.openPedido=function(i,t){o.userRole=t,o.infoModal.pedido=""!=i?r("getById")(o.data,i):"",o.infoModal.userRole=t,angular.element("#fechaPedido").focus();var n=e.open({templateUrl:dir_root+"/templates/pedidos/addedit.html",windowClass:"wndPedido",controller:"ModalPedidoInstanceCtrl",backdrop:"static",keyboard:!0,resolve:{info:function(){return o.infoModal}}});n.result.then(function(e){""==o.infoModal.pedido?d.addPedido(e).then(function(e){o.data.splice(0,0,e.data.DATA),a.add("success","Se creó un nuevo pedido.",1e3)},function(o){a.add("danger",o.data.MSG)}):d.editPedido(e).then(function(d){var i=r("getIndexById")(o.data,e.pedido.id);o.data[i]=d.data.DATA,a.add("success","Se actualizó la información del pedido.",1e3)},function(o){a.add("danger",o.data.MSG)}),"print"==e.action&&o.print(e.pedido)},function(i){if("delete"==i.action){var t={msj:"¿Está seguro que desea eliminar este pedido?",accept:"Si",cancel:"No"},n=i.idPedido,l=e.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:"modalConfirmCtrl",resolve:{txt:function(){return t}}});l.result.then(function(){d.deletePedido(n).then(function(){var e=r("getIndexById")(o.data,n);o.data.splice(e,1)},function(o){a.add("danger",o.data.MSG)})},function(){})}})},o.nuevo=function(e){o.userRole=e,o.openPedido("",e)},o.print=function(d){controllerPrint=""==o.userRole||"admin"==o.userRole?modalPdfPedidoCtrl:modalPdfPedidoNotAdminCtrl,n.cliente(d.clientesPM_id).then(function(o){d.datosCliente=o.data.DATA;e.open({templateUrl:dir_root+"/templates/printDoc.html",windowClass:"wndPdf",controller:controllerPrint,resolve:{pedido:function(){return d}}})},function(o){a.add("danger",o.data.MSG)})},$("#infinite-scrolling").size()>0?void $(window).on("scroll",function(){$(window).scrollTop()>$(document).height()-$(window).height()-60&!o.parar&!o.pending&&o.cargarPedidos()}):void 0}]),app.controller("ModalPedidoInstanceCtrl",["$scope","$modalInstance","$filter","pedidosService","productosService","clientesPMService","info",function(o,e,d,t,n,a,r){if(o.alerts=[],o.userRole=r.userRole,o.form={},o.p={mod_options:[],cl_options:[]},o.form.idModelo="",o.form.modelo={nombre:"",id:"",precio:"",cantidad:""},o.form.pago={monto:"",FP:"Efectivo",created:(new Date).toISOString().slice(0,10)},o.actionBeforeSave="",o.fps=[{label:"Efectivo",value:"Efectivo"},{label:"Tarjeta",value:"Tarjeta"},{label:"Cheque",value:"Cheque"},{label:"Transf. Victor",value:"Transf. Victor"},{label:"Transf. Fede",value:"Transf. Fede"}],o.estadosProductos=["Pendiente","Terminado"],$.mockjax({url:"/estadosProductos",status:200,responseTime:400,response:function(){this.responseText=o.estadosProductos}}),o.search=function(){""!=o.form.idModelo&&n.getProductoModelo(o.form.idModelo).then(function(e){o.form.modelo=e.data.DATA},function(d){(403==d.status||401==d.status)&&(e.dismiss({action:"cancel"}),$location.path("/index")),o.form.modelo.nombre=""})},o.searchByName=function(){""!=o.form.modelo.nombre&&n.getProductoModeloByName(o.form.modelo.nombre).then(function(e){o.p.mod_options=e.data.DATA},function(d){(403==d.status||401==d.status)&&(e.dismiss({action:"cancel"}),$location.path("/index")),o.p.mod_options=[]})},o.setModel=function(e){o.form.modelo=e,o.form.idModelo=e.id},o.searchClienteByName=function(){""!=o.form.cliente.nombre&&a.getClienteByName(o.form.cliente.nombre).then(function(e){o.p.cl_options=e.data.DATA},function(d){(403==d.status||401==d.status)&&(e.dismiss({action:"cancel"}),$location.path("/index")),o.p.cl_options=[]})},o.setCliente=function(e){o.form.cliente=e,o.form.idCliente=e.id,o.pedido.bonificacion=o.form.cliente.bonificacion},o.sumarPagos=function(){if(void 0!=o.pedido.pagos){var e=0;for(i=0;i<o.pedido.pagos.length;i++)e+=parseFloat(o.pedido.pagos[i].monto,10);return e}},""!=r.pedido){var l=angular.copy(r.pedido);o.pedido=r.pedido,o.pedido.bonificacion=parseInt(o.pedido.bonificacion,10),o.pedido.fecha=new Date(o.pedido.fecha).toISOString().slice(0,10),o.pedido.pagos=[],"Entregado-Pago"==o.pedido.estado||"Entregado-Debe"==o.pedido.estado?o.estados=["Entregado-Pago","Entregado-Debe"]:(o.estados=["Pendiente","Terminado","Entregado-Pago","Entregado-Debe"],o.EditEnabled="admin"==o.userRole||"taller"==o.userRole),t.modelosPedido(r.pedido.id).then(function(e){o.pedido.modelos=e.data.DATA},function(o){AlertService.add("danger",o.data.MSG)}),t.pagosPedido(r.pedido.id).then(function(e){o.pedido.pagos=e.data.DATA||[],o.pedido.totalPagos=o.sumarPagos()},function(o){AlertService.add("danger",o.data.MSG)}),o.form.cliente={nombre:o.pedido.cliente,id:o.pedido.clientesPM_id,bonificacion:"0"}}else o.pedido={fecha:(new Date).toISOString().slice(0,10),fecha_entrega:(new Date).toISOString().slice(0,10),estado:"Pendiente",total:"0",clientesPM_id:"",cliente:"",modelos:[],pagos:[],bonificacion:0,totalFinal:0,FP:"",nota:""},o.form.cliente={nombre:"",id:"",bonificacion:0},o.EditEnabled=!0,o.estados=["Pendiente","Terminado","Entregado-Pago","Entregado-Debe"],o.pedido.totalPagos=0;o.pedido.mod2delete=[],o.pedido.pagos2delete=[],o.ok=function(){e.close({pedido:o.pedido,action:o.actionBeforeSave})},o.print=function(){o.actionBeforeSave="print"},o.save=function(){o.actionBeforeSave=""},o.cancel=function(){void 0!=o.pedido.id&&o.back2original(),e.dismiss({action:"cancel"})},o.deletePedido=function(){o.back2original();var d={action:"delete",idPedido:o.pedido.id};e.dismiss(d)},o.back2original=function(){o.pedido.cliente=l.cliente,o.pedido.total=l.total,o.pedido.estado=l.estado,o.pedido.nota=l.nota,o.pedido.clientesPM_id=l.clientesPM_id,o.pedido.bonificacion=l.bonificacion,o.pedido.modelos=l.modelos,o.pedido.mod2delete=[]},o.add=function(){""!=o.form.modelo.nombre&&void 0!=o.form.modelo.nombre&&(o.form.modelo.cantidad=o.form.modelo.cantidad||1,$mod={id:o.form.modelo.id,nombre:o.form.modelo.nombre,precio:o.form.modelo.precio,cantidad:o.form.modelo.cantidad,estado:"Pendiente"},o.pedido.modelos.push($mod),o.pedido.total=parseInt(o.pedido.total,10)+parseInt(o.form.modelo.precio,10)*parseInt(o.form.modelo.cantidad,10),o.pedido.totalFinal=parseInt(o.pedido.total,10)-parseInt(o.pedido.total,10)*parseInt(o.pedido.bonificacion,10)/100,o.form.modelo={nombre:"",id:"",precio:"",cantidad:""},angular.element("#newModId").focus(),angular.element("#newMod").val(""),angular.element("#newModId").val(""))},o.remove=function(e){o.pedido.total=parseInt(o.pedido.total,10)-parseInt(o.pedido.modelos[e].precio,10)*parseInt(o.pedido.modelos[e].cantidad,10),null!=o.pedido.modelos[e].idPedMod&&o.pedido.mod2delete.push({id:o.pedido.modelos[e].idPedMod}),o.pedido.modelos.splice(e,1)},o.removeOld=function(e){o.pedido.total=parseInt(o.pedido.total,10)-parseInt(o.pedido.modelos[e].precio,10)*parseInt(o.pedido.modelos[e].cantidad,10)},o.refreshTotal=function(e){o.pedido.total=parseInt(o.pedido.total,10)+parseInt(o.pedido.modelos[e].precio,10)*parseInt(o.pedido.modelos[e].cantidad,10)},o.$watch("form.cliente",function(){null!=o.form.cliente.id&&0!=o.form.cliente.id&&(null!=o.pedido.bonificacion&&"0"==o.pedido.bonificacion&&(o.pedido.bonificacion=angular.copy(o.form.cliente.bonificacion)),o.pedido.clientesPM_id=o.form.cliente.id,o.pedido.clientesPM=o.form.cliente.nombre)}),o.$watch("pedido.bonificacion",function(){var e=parseInt(o.pedido.total,10)*(parseInt(o.pedido.bonificacion,10)/100);o.pedido.totalFinal=parseInt(o.pedido.total,10)-e}),o.$watch("pedido.total",function(){var e=parseInt(o.pedido.total,10)*(parseInt(o.pedido.bonificacion,10)/100);o.pedido.totalFinal=parseInt(o.pedido.total,10)-e}),o.$watch("pedido.estado",function(e,d){if("Terminado"==e&"Terminado"!=d)for(i=0;i<o.pedido.modelos.length;i++)o.pedido.modelos[i].estado="Terminado"}),o.$watch("pedido.modelos",function(){if(void 0!=o.pedido.modelos){var e=0;for(i=0;i<o.pedido.modelos.length;i++)e+=o.pedido.modelos[i].cantidad*o.pedido.modelos[i].precio;o.pedido.total=e}},!0),o.addPago=function(){""!=o.form.pago.monto&""!=o.form.pago.FP&&(o.form.pago.created=o.form.pago.created||(new Date).toISOString().slice(0,10),o.pedido.pagos.push(o.form.pago),o.pedido.totalPagos=parseFloat(o.pedido.totalPagos)+parseFloat(o.form.pago.monto),o.form.pago={monto:"",FP:"Efectivo",created:(new Date).toISOString().slice(0,10)},angular.element("#montoPago").focus(),angular.element("#montoPago").val(""),o.pedido.totalFinal-o.pedido.totalPagos==0&&(o.pedido.estado="Entregado-Pago"))},o.removePago=function(e){o.pedido.totalPagos=parseInt(o.pedido.totalPagos,10)-parseInt(o.pedido.pagos[e].monto,10),null!=o.pedido.pagos[e].id&&o.pedido.pagos2delete.push({id:o.pedido.pagos[e].id}),o.pedido.pagos.splice(e,1)}}]);
app.controller("pedidosdeclientesCtrl",["$scope","$modal","pedidosService","productosService","clientesPMService","AlertService","$filter","$routeParams","$location","$rootScope",function(d,o,e,a,t,i,n,l,c,r){$(window).unbind("scroll"),r.activeTab="pedidosdeclientes",d.order=["-nombre"],d.query="",d.pedido={},d.data="",d.alerts=[];var s=l.token;t.tienePermiso(s).then(function(o){d.pedido.cliente_name=o.data.DATA.nombre,d.pedido.clientesPM_id=o.data.DATA.id,d.pedido.bonificacion=o.data.DATA.bonificacion,d.pedido.fecha=formatLocalDate(),d.pedido.total=0,d.pedido.totalFinal=0,d.pedido.nota="",d.pedido.modelos=[],a.prodsPedido(s).then(function(o){d.data=o.data.DATA,d.initCantidad()},function(o){i("danger",o.data.MSG,3e3),d.data=""})},function(d){i.add("danger",d.data.MSG,3e3)}),d.initCantidad=function(){d.data.forEach(function(d){d.modelos.forEach(function(d){d.cantidad=0})})},d.add=function(o){for(var e=0;e<d.data[o].modelos.length;e++)0!=d.data[o].modelos[e].cantidad&&(m=n("getIndexById")(d.pedido.modelos,d.data[o].modelos[e].id),null!=m?d.pedido.modelos[m].cantidad=parseInt(d.pedido.modelos[m].cantidad)+parseInt(d.data[o].modelos[e].cantidad):d.pedido.modelos.push({id:d.data[o].modelos[e].id,nombre:d.data[o].nombre+"-"+d.data[o].modelos[e].nombre,precio:d.data[o].precio,cantidad:d.data[o].modelos[e].cantidad,estado:"Pendiente"}),d.pedido.total=d.pedido.total+d.data[o].modelos[e].cantidad*d.data[o].precio,d.pedido.totalFinal=parseFloat(d.pedido.total)-d.pedido.total*d.pedido.bonificacion/100,d.data[o].modelos[e].cantidad=0);i.add("success","Se agregó al pedido "+d.data[o].nombre,2e3)},d.viewPedido=function(){var a=o.open({templateUrl:dir_root+"/templates/pedidosdeclientes/pedido.html",windowClass:"wndPedido",controller:"ModalPedidodeclientesCtrl",backdrop:"static",keyboard:!0,resolve:{info:function(){return d.pedido}}});a.result.then(function(){var a={msj:"Se enviará el pedido. ¿Desea continuar?",accept:"Si",cancel:"No"},t=o.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:"modalConfirmCtrl",resolve:{txt:function(){return a}}});t.result.then(function(){e.confirmarPedido(d.pedido,s).then(function(){i.add("success","El pedido fue realizado.",3e3),d.data=[]},function(o){i.add("danger",o.data.MSG),d.data=""})})},function(){})}}]),app.controller("ModalPedidodeclientesCtrl",["$scope","$modalInstance","productosService","AlertService","ventasService","$filter","info","$location",function(d,o,e,a,t,i,n){d.pedido=n,d.cancel=function(){o.dismiss()},d.ok=function(){o.close()},d.remove=function(o){d.pedido.total=parseFloat(d.pedido.total,10)-parseFloat(d.pedido.modelos[o].precio,10)*parseInt(d.pedido.modelos[o].cantidad,10),d.pedido.modelos.splice(o,1)},d.$watch("pedido.modelos",function(){d.refreshTotal()},!0),d.refreshTotal=function(){total=0,d.pedido.modelos.forEach(function(d){total+=d.precio*parseInt(d.cantidad)}),d.pedido.total=total}}]);
app.controller("pedidosespecialesCtrl",["$scope","$modal","pedidosespecialesService","AlertService","$filter",function(e,o,d,a,t){return e.userRole="",e.order=["-created","-id"],e.filterPedidos={estado:"Pendiente"},e.query="",e.filterSubmitted="",e.alerts=[],e.page=0,e.data=[],e.parar=!1,e.pending=!1,e.cargarPedidos=function(){e.page++,e.pending=!0,d.pedidos(e.filterPedidos.estado,e.page,e.filterSubmitted).then(function(o){if(o.data.DATA.length>0)for(i=0;i<o.data.DATA.length;i++)e.data.push(o.data.DATA[i]);else e.data.length>0&&$(".finPedidos").html('<div class="fin"></div>'),e.parar=!0;e.pending=!1},function(o){e.pending=!1,a.add("danger",o.data.MSG),$location.path("/login")})},e.cargarPedidos(),e.filtrarPedidos=function(){e.parar=!1,e.data=[],e.page=0,e.filterSubmitted=e.query,e.cargarPedidos()},e.$watch("filterPedidos.estado",function(o,d){o!=d&&e.filtrarPedidos()},!0),e.openPedido=function(i,n){e.infoModal={},e.userRole=n,e.infoModal.pedido=""!=i?t("getById")(e.data,i):"",e.infoModal.userRole=n,angular.element("#fechaPedido").focus();var r=o.open({templateUrl:dir_root+"/templates/pedidosespeciales/addedit.html",windowClass:"wndPedidoespecial",controller:"ModalPedidoespecialInstanceCtrl",backdrop:"static",keyboard:!0,resolve:{info:function(){return e.infoModal}}});r.result.then(function(o){""==e.infoModal.pedido?d.addPedido(o).then(function(o){e.data.splice(0,0,o.data.DATA),a.add("success",o.data.MSG,3e3)},function(e){a.add("danger",e.data.MSG)}):d.editPedido(o).then(function(d){var i=t("getIndexById")(e.data,o.pedido.id);e.data[i]=d.data.DATA,a.add("success","Se actualizó la información del pedido especial.",1e3)},function(e){a.add("danger",e.data.MSG)}),"print"==o.action&&e.print(o.pedido)},function(i){if("delete"==i.action){var n={msj:"¿Está seguro que desea eliminar este pedido?",accept:"Si",cancel:"No"},r=i.idPedido,l=o.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:"modalConfirmCtrl",resolve:{txt:function(){return n}}});l.result.then(function(){d.deletePedido(r).then(function(){var o=t("getIndexById")(e.data,r);e.data.splice(o,1)},function(e){a.add("danger",e.data.MSG)})},function(){})}})},e.nuevo=function(o){e.userRole=o,e.openPedido("",o)},$("#infinite-scrolling").size()>0?void $(window).on("scroll",function(){$(window).scrollTop()>$(document).height()-$(window).height()-60&!e.parar&!e.pending&&e.cargarPedidos()}):void 0}]),app.controller("ModalPedidoespecialInstanceCtrl",["$scope","$modalInstance","$filter","pedidosespecialesService","clientesService","info",function(e,o,d,a,t,n){if(e.alerts=[],e.fps=[{label:"Efectivo",value:"Efectivo"},{label:"Tarjeta",value:"Tarjeta"},{label:"Cheque",value:"Cheque"},{label:"Transferencia",value:"Transferencia"}],e.sumarPagos=function(){if(void 0!=e.pedido.pagos){var o=0;for(i=0;i<e.pedido.pagos.length;i++)o+=parseFloat(e.pedido.pagos[i].monto,10);return o}},e.userRole=n.userRole,e.form={},e.p={},e.form.pago={monto:"",FP:"Efectivo",created:(new Date).toISOString().slice(0,10),bonificacion:""},e.getList=function(e){return t.list(e)},e.actionBeforeSave="",""!=n.pedido){var r=angular.copy(n.pedido);e.pedido=n.pedido,e.pedido.total=parseFloat(n.pedido.total),e.pedido.bonificacion=parseInt(e.pedido.bonificacion,10),e.pedido.fecha=new Date(e.pedido.created).toISOString().slice(0,10),e.pedido.pagos=[],"Entregado-Pago"==e.pedido.estado||"Entregado-Debe"==e.pedido.estado?e.estados=["Entregado-Pago","Entregado-Debe"]:(e.estados=["Pendiente","Terminado","Entregado-Pago","Entregado-Debe"],e.EditEnabled="admin"==e.userRole||"taller"==e.userRole),a.pagosPedido(n.pedido.id).then(function(o){e.pedido.pagos=o.data.DATA||[],e.pedido.totalPagos=e.sumarPagos()},function(e){AlertService.add("danger",e.data.MSG)}),e.form.cliente={nombre:e.pedido.cliente,id:e.pedido.clientes_id}}else e.pedido={created:formatLocalDate(),fecha_entrega:formatLocalDate(),estado:"Pendiente",total:"",clientes_id:"",cliente:"",pagos:[],bonificacion:0,FP:"",descripcion:""},e.form.cliente={nombre:"",id:""},e.EditEnabled=!0,e.estados=["Pendiente","Terminado","Entregado-Pago","Entregado-Debe"],e.pedido.totalPagos=0;e.pedido.pagos2delete=[],e.ok=function(){e.pedido.clientes_id=e.form.cliente.id,e.pedido.cliente=e.form.cliente.nombre,o.close({pedido:e.pedido,action:e.actionBeforeSave})},e.save=function(){e.actionBeforeSave=""},e.cancel=function(){void 0!=e.pedido.id&&e.back2original(),o.dismiss({action:"cancel"})},e.deletePedido=function(){e.back2original();var d={action:"delete",idPedido:e.pedido.id};o.dismiss(d)},e.back2original=function(){e.pedido.cliente=r.cliente,e.pedido.total=r.total,e.pedido.estado=r.estado,e.pedido.descripcion=r.descripcion,e.pedido.clientes_id=r.clientes_id,e.pedido.bonificacion=r.bonificacion},e.addPago=function(){""!=e.form.pago.monto&""!=e.form.pago.FP&&(e.form.pago.created=e.form.pago.created||(new Date).toISOString().slice(0,10),e.form.pago.bonificacion=e.form.pago.bonificacion||0,e.pedido.pagos.push(e.form.pago),e.pedido.totalPagos=parseFloat(e.pedido.totalPagos)+parseFloat(e.form.pago.monto),e.form.pago={monto:"",FP:"Efectivo",created:(new Date).toISOString().slice(0,10)},angular.element("#montoPago").focus(),angular.element("#montoPago").val(""),parseFloat(e.pedido.total)-e.pedido.totalPagos==0&&(e.pedido.estado="Entregado-Pago"))},e.removePago=function(o){e.pedido.totalPagos=parseInt(e.pedido.totalPagos,10)-parseInt(e.pedido.pagos[o].monto,10),null!=e.pedido.pagos[o].id&&e.pedido.pagos2delete.push({id:e.pedido.pagos[o].id}),e.pedido.pagos.splice(o,1)}}]);
app.controller("produccionesCtrl",["$scope","$modal","$filter","produccionesService","productosService","responsablesService","AlertService",function(o,e,n,c,r,d,t){return o.alerts=[],$("#tabs a").click(function(o){o.preventDefault(),$(this).tab("show")}),o.filterProds={estado:"Retirado"},o.order=["-fecha","-id"],o.query="",o.filterSubmitted="",o.page=0,o.data=[],o.parar=!1,o.pending=!1,o.cargarProducciones=function(){o.parar||(o.parar=!0,o.pending=!0,o.page++,c.producciones(o.filterProds.estado,o.page,o.filterSubmitted).then(function(e){if(e.data.DATA.length>0){for(i=0;i<e.data.DATA.length;i++)o.data.push(e.data.DATA[i]);o.parar=!1}else o.data.length>0&&$(".finProducciones").html('<div class="fin"></div>'),o.parar=!0;o.pending=!1},function(e){o.pending=!1,t.add("danger",e.data.MSG)}))},o.filtrarProducciones=function(){o.parar=!1,o.data=[],o.page=0,o.filterSubmitted=o.query,o.cargarProducciones()},o.$watch("filterProds.estado",function(e,n){e!=n&&o.filtrarProducciones()},!0),o.infoModal={},o.openProduccion=function(i){o.infoModal.produccion=""!=i?n("getById")(o.data,i):"",angular.element("#fechaProduccion").focus();var r=e.open({templateUrl:dir_root+"/templates/producciones/addedit.html",windowClass:"wndProduccion",controller:"ModalProduccionInstanceCtrl",backdrop:"static",keyboard:!0,resolve:{info:function(){return o.infoModal}}});r.result.then(function(e){""==o.infoModal.produccion?c.addProduccion(e).then(function(n){o.data.splice(0,0,n.data.DATA),t.add("success","Se creó una nueva producción.",1e3),"print"==e.action&&o.print(n.data.DATA)},function(o){t.add("danger",o.data.MSG)}):c.editProduccion(e).then(function(c){var i=n("getIndexById")(o.data,c.data.DATA.id);o.data[i]=c.data.DATA,t.add("success","Se actualizó la información de la producción.",1e3),"print"==e.action&&o.print(c.data.DATA)},function(o){t.add("danger",o.data.MSG)})},function(i){if("delete"==i.action){var r={msj:"¿Está seguro que desea eliminar esta producción?",accept:"Si",cancel:"No"},d=i.idProduccion,a=e.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:"modalConfirmCtrl",resolve:{txt:function(){return r}}});a.result.then(function(){c.deleteProduccion(d).then(function(){var e=n("getIndexById")(o.data,d);o.data.splice(e,1)},function(o){t.add("danger",o.data.MSG)})},function(){})}})},o.nuevo=function(e){o.openProduccion("",e)},o.print=function(o){e.open({templateUrl:dir_root+"/templates/printDoc.html",windowClass:"wndPdf",controller:modalPdfProduccionCtrl,resolve:{produccion:function(){return o}}})},$("#infinite-scrolling").size()>0?void $(window).on("scroll",function(){$(window).scrollTop()>$(document).height()-$(window).height()-60&!o.parar&!o.pending&&o.cargarProducciones()}):void 0}]),app.controller("ModalProduccionInstanceCtrl",["$scope","$modalInstance","$filter","produccionesService","productosService","responsablesService","info",function(o,e,n,c,i,r,d){if(o.estados=["Retirado","Devuelto"],$.mockjax({url:"/estados",status:200,responseTime:400,response:function(){this.responseText=o.estados}}),o.form={},o.p={},o.form.modelo={nombre:"",id:""},""!=d.produccion){var t=angular.copy(d.produccion);o.produccion=d.produccion,o.form.responsable={nombre:o.produccion.responsable,id:o.produccion.responsables_id},c.modelosProduccion(d.produccion.id).then(function(e){o.produccion.modelos=e.data.DATA},function(o){AlertService.add("danger",o.data.MSG)}),o.produccion.fecha=new Date(o.produccion.fecha).toISOString().slice(0,10),o.produccion.fecha_devolucion=new Date(o.produccion.fecha_devolucion).toISOString().slice(0,10)}else{o.produccion={fecha:(new Date).toISOString().slice(0,10),fecha_devolucion:(new Date).toISOString().slice(0,10),estado:"Retirado",responsables_id:"",responsable:"",modelos:[],motivo:"",nota:""};var t=o.produccion;o.form.responsable={nombre:"",id:""}}o.produccion.mod2delete=[],o.actionBeforeSave="",o.search=function(){""!=o.form.idModelo&&i.getProductoModelo(o.form.idModelo).then(function(e){o.form.modelo=e.data.DATA},function(n){(403==n.status||401==n.status)&&(e.dismiss({action:"cancel"}),$location.path("/index")),o.form.modelo.nombre=""})},o.searchByName=function(){""!=o.form.modelo.nombre&&i.getProductoModeloByName(o.form.modelo.nombre).then(function(e){o.p.mod_options=e.data.DATA},function(n){(403==n.status||401==n.status)&&(e.dismiss({action:"cancel"}),$location.path("/index")),o.p.mod_options=[]})},o.setModel=function(e){o.form.modelo=e,o.form.idModelo=e.id},o.searchResponsableByName=function(){""!=o.form.responsable.nombre&&r.getResponsableByName(o.form.responsable.nombre).then(function(e){o.p.resp_options=e.data.DATA},function(n){(403==n.status||401==n.status)&&(e.dismiss({action:"cancel"}),$location.path("/login")),o.p.cl_options=[]})},o.setResponsable=function(e){o.form.responsable=e,o.form.isResponsable=e.id},o.ok=function(){e.close({produccion:o.produccion,action:o.actionBeforeSave})},o.print=function(){o.actionBeforeSave="print"},o.save=function(){o.actionBeforeSave=""},o.cancel=function(){o.back2original(),e.dismiss({action:"cancel"})},o.deleteProduccion=function(){o.back2original();var n={action:"delete",idProduccion:o.produccion.id};e.dismiss(n)},o.back2original=function(){o.produccion.responsable=t.responsable,o.produccion.nota=t.nota,o.produccion.responsables_id=t.responsables_id,o.produccion.fecha=t.fecha,o.produccion.fecha_devolucion=t.fecha_devolucion,o.produccion.estado=t.estado,o.produccion.modelos=t.modelos,o.produccion.mod2delete=[]},o.$watch("form.responsable",function(){null!=o.form.responsable.id&&0!=o.form.responsable.id&&(o.produccion.responsables_id=o.form.responsable.id,o.produccion.responsable=o.form.responsable.nombre)}),o.add=function(){""!=o.form.modelo.nombre&&void 0!=o.form.modelo.nombre&&($mod={id:o.form.modelo.id,nombre:o.form.modelo.nombre,estado:"Retirado"},o.produccion.modelos.push($mod),o.form.modelo={nombre:"",id:""},angular.element("#newModId").focus(),angular.element("#newMod").val(""))},o.remove=function(e){null!=o.produccion.modelos[e].idProdMod&&o.produccion.mod2delete.push({id:o.produccion.modelos[e].idProdMod}),o.produccion.modelos.splice(e,1)},o.todosDevueltos=function(){o.produccion.modelos.forEach(function(o){o.estado="Devuelto"})}}]);
app.controller("productosCtrl",["$scope","$modal","$filter","productosService","$log","AlertService",function(o,t,d,a,e,n){o.order="-nombre",o.filterProds={enProduccion:1},o.infoModal={},o.alerts=[],$(window).unbind("scroll"),a.productos().then(function(t){o.data=t.data.DATA},function(){}),o.exceptEmptyComparator=function(o,t){return t?angular.equals(t,o):!0},o.reponer=function(t,e){var n=d("getById")(o.data,t);a.reponerProducto(n.modelos[e].id),n.modelos[e].stock++},o.openProducto=function(e,r){o.infoModal.producto=""!=e?d("getById")(o.data,e):"",o.infoModal.userRole=r,angular.element("#nombre").focus();var c=t.open({templateUrl:dir_root+"/templates/productos/addedit.html",windowClass:"wndProducto",controller:"ModalInstanceCtrl",backdrop:"static",keyboard:!0,resolve:{info:function(){return o.infoModal}}});c.result.then(function(t){""==e?a.addProducto(t).then(function(t){o.data.push(t.data.DATA)},function(o){var t=o.data.MSG;n.add("danger",t,5e3)}):a.editProducto(t).then(function(t){var a=d("getIndexById")(o.data,t.data.DATA.id);o.data[a]=t.data.DATA,n.add("success","Se guardaron las modificaciones",1e3)},function(o){n.add("danger",o.data.MSG,2e3)})},function(e){if("delete"==e.action){var r={msj:"¿Está seguro que desea eliminar este producto?",accept:"Si",cancel:"No"},c=e.idProd,l=t.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:"modalConfirmCtrl",resolve:{txt:function(){return r}}});l.result.then(function(){a.deleteProducto(c).then(function(){var t=d("getIndexById")(o.data,c);o.data.splice(t,1)},function(o){n.add("danger",o.data.MSG)})},function(){})}})},o.nuevo=function(t){o.openProducto("",t)},o.search=function(t){if(void 0===o.queryId||0===o.queryId.length)return!0;var d=!1;return angular.forEach(t.modelos,function(t){t.id==parseInt(o.queryId)&&(d=!0)}),d}}]),app.controller("ModalInstanceCtrl",["$scope","$modalInstance","$filter","info","$modal",function(o,t,d,a,e){if(""!=a.producto){var n=angular.copy(a.producto);o.producto=a.producto}else{o.producto={nombre:"",precio:"",img:"img/productos/noimg.jpg",modelos:[],enProduccion:"1"};var n=o.producto}o.producto.mod2delete=[],o.producto.mod2baja=[],o.producto.mod2alta=[],o.userRole=a.userRole,o.ok=function(){t.close(o.producto)},o.cancel=function(){o.back2original(),t.dismiss({action:"cancel"})},o.deleteProducto=function(){o.back2original();var d={action:"delete",idProd:o.producto.id};t.dismiss(d)},o.back2original=function(){o.producto.nombre=n.nombre,o.producto.precio=n.precio,o.producto.stock=n.stock,o.producto.enProduccion=n.enProduccion,o.producto.modelos=n.modelos,o.producto.img=n.img,o.producto.mod2delete=[],o.producto.mod2baja=[],o.producto.mod2alta=[]},o.remove=function(t){var d={msj:"¿Está seguro que desea eliminar este color del producto?",accept:"Si",cancel:"No"},a=e.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:"modalConfirmCtrl",resolve:{txt:function(){return d}}});a.result.then(function(){idMod=o.producto.modelos[t].id,o.producto.modelos.splice(t,1),null!=idMod&&o.producto.mod2delete.push({id:idMod})},function(){})},o.add=function(t){o.producto.modelos.push({nombre:t||"",fechaVenta:"",fechaRep:"",stock:0}),angular.element("#newMod").val(""),angular.element("#newMod").focus()},o.baja=function(t){var a=o.producto.modelos[t].id,n=d("getIndexById")(o.producto.mod2baja,a);if(null!=n)o.producto.mod2baja[n].cantBaja=o.producto.mod2baja[n].cantBaja+1,o.producto.modelos[t].stock--;else{var r=d("getIndexById")(o.producto.mod2alta,a);if(null!=r)o.producto.mod2alta[r].cantAlta=o.producto.mod2alta[r].cantAlta-1,o.producto.modelos[t].stock--,0==o.producto.mod2alta[r].cantAlta&&o.producto.mod2alta.splice(r,1);else{var c=e.open({templateUrl:dir_root+"/templates/productos/confirmarBaja.html",windowClass:"wndBajaProducto",controller:ModalBajaCtrl,backdrop:"static",keyboard:!0});c.result.then(function(d){o.producto.modelos[t].stock--,o.producto.mod2baja.push({id:a,cantBaja:1,nota:d})},function(){})}}},o.alta=function(t){o.producto.modelos[t].stock++;var a=o.producto.modelos[t].id,e=d("getIndexById")(o.producto.mod2alta,a);if(null!=e)o.producto.mod2alta[e].cantAlta=o.producto.mod2alta[e].cantAlta+1;else{var n=d("getIndexById")(o.producto.mod2baja,a);null!=n?(o.producto.mod2baja[n].cantBaja=o.producto.mod2baja[n].cantBaja-1,0==o.producto.mod2baja[n].cantBaja&&o.producto.mod2baja.splice(n,1)):o.producto.mod2alta.push({id:a,cantAlta:1})}}}]),app.controller("ModalBajaCtrl",["$scope","$modalInstance",function(o,t){o.nota={texto:""},o.ok=function(){t.close(o.nota.texto)},o.cancel=function(){t.dismiss()}}]);
app.controller("productosparapedidosCtrl",["$scope","$modal","$filter","productosService","$log","AlertService",function(t,a,o,d,r,n){return t.order="-nombre",t.textAdd={0:"Agregar",1:"Quitar"},t.alerts=[],t.page=0,t.data=[],t.parar=!1,t.pending=!1,t.filterSubmitted="",t.cargarProductos=function(){t.page++,t.pending=!0,d.getproductos(t.page,t.filterSubmitted).then(function(a){if(a.data.DATA.length>0)for(i=0;i<a.data.DATA.length;i++)t.data.push(a.data.DATA[i]);else t.data.length>0&&$(".finProductos").html('<div class="fin"></div>'),t.parar=!0;t.pending=!1},function(a){t.pending=!1,n.add("danger",a.data.MSG),$location.path("/login")})},t.cargarProductos(),t.filtrarProductos=function(){t.parar=!1,t.data=[],t.page=0,t.filterSubmitted=t.query,t.cargarPruductos()},t.habilitar=function(a,i){var r,e=o("getById")(t.data,a);r=1==e.modelos[i].pedido?0:1,d.habilitarModelo(e.modelos[i].id,r).then(function(){e.modelos[i].pedido=r},function(t){n.add("danger",t.data.MSG)})},t.habilitarTodos=function(a,i){var r=o("getById")(t.data,a);d.habilitarProducto(r.id,i).then(function(){r.modelos.forEach(function(t){t.pedido=i})},function(t){n.add("danger",t.data.MSG)})},$("#infinite-scrolling").size()>0?void $(window).on("scroll",function(){$(window).scrollTop()>$(document).height()-$(window).height()-60&!t.parar&!t.pending&&t.cargarProductos()}):void 0}]);
app.controller("responsablesCtrl",["$scope","$modal","$filter","$log","AlertService","responsablesService","$timeout",function(e,a,n,t,o,s){return e.order="-nombre",e.query="",e.filterSubmitted="",e.page=0,e.data=[],e.parar=!1,e.pending=!1,e.cargarResponsables=function(){e.page++,e.pending=!0,s.responsables(e.page,e.filterSubmitted).then(function(a){if(a.data.DATA.length>0)for(i=0;i<a.data.DATA.length;i++)e.data.push(a.data.DATA[i]);else e.data.length>0&&$(".finResponsables").html('<div class="fin"></div>'),e.parar=!0;e.pending=!1},function(a){e.pending=!1,o.add("danger",a.data.MSG),$location.path("/login")})},e.cargarResponsables(),e.filtrarResponsables=function(){e.parar=!1,e.data=[],e.page=0,e.filterSubmitted=e.query,e.cargarResponsables()},e.openRes=function(t){e.selectedRes=""!=t?n("getById")(e.data,t):"",angular.element("#nombre").focus();var l=a.open({templateUrl:dir_root+"/templates/responsables/addedit.html",windowClass:"wndClientesPM",controller:"ModalResponsablesInstanceCtrl",backdrop:"static",keyboard:!0,resolve:{responsable:function(){return e.selectedRes}}});l.result.then(function(a){""==e.selectedRes?s.addRes(a).then(function(a){lastName=e.data[e.data.length-1].nombre.toUpperCase(),newName=a.data.DATA.nombre.toUpperCase(),lastName>newName&&e.data.push(a.data.DATA),o.add("success",a.data.MSG,5e3)},function(e){var a=e.data.MSG;o.add("danger",a,5e3)}):s.editRes(a).then(function(){o.add("success","Se actualizó la información del responsable de producción.",1500)},function(e){o.add("danger",e.data.MSG)})},function(t){if("delete"==t.action){var l={msj:"¿Está seguro que desea eliminar este responsables de producción?",accept:"Si",cancel:"No"},r=t.idR,i=a.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:"modalConfirmCtrl",resolve:{txt:function(){return l}}});i.result.then(function(){s.deleteRes(r).then(function(){var a=n("getIndexById")(e.data,r);e.data.splice(a,1)},function(e){o.add("danger",e.data.MSG)})},function(){})}})},e.nuevo=function(){e.openRes("")},$("#infinite-scrolling").size()>0?void $(window).on("scroll",function(){$(window).scrollTop()>$(document).height()-$(window).height()-60&!e.parar&!e.pending&&e.cargarResponsables()}):void 0}]),app.controller("ModalResponsablesInstanceCtrl",["$scope","$modalInstance","$filter","responsable",function(e,a,n,t){if(""!=t){var o=angular.copy(t);e.responsable=t}else{e.responsable={nombre:"",tel:"",tel2:"",direccion:"",localidad:"",email:"",marca:"",nota:""};var o=e.responsable}e.ok=function(){a.close({responsables:e.responsable})},e.cancel=function(){e.back2original(),a.dismiss({action:"cancel"})},e.deleteRes=function(){e.back2original();var n={action:"delete",idR:e.responsable.id};a.dismiss(n)},e.back2original=function(){e.responsable.id=o.id,e.responsable.nombre=o.nombre,e.responsable.marca=o.local,e.responsable.tel=o.tel,e.responsable.tel2=o.tel2,e.responsable.direccion=o.direccion,e.responsable.localidad=o.localidad,e.responsable.email=o.email,e.responsable.nota=o.nota}}]);
app.controller("resumenCtrl",["$scope","$modal","resumenService","AlertService","$filter","AuthService",function(a,e,t,r,o,s){a.alerts=[],fechaHoy=formatLocalDate(),a.value="hoy",a.desde=fechaHoy,a.hasta=fechaHoy,$(window).unbind("scroll"),a.cargar=function(){t.resumen(a.desde,a.hasta).then(function(e){a.resumenVentas={tarjeta:parseFloat(e.data.DATA.resumenVentas.Tarjeta,10),debito:parseFloat(e.data.DATA.resumenVentas.Debito,10),cheque:parseFloat(e.data.DATA.resumenVentas.Cheque,10),efectivo:parseFloat(e.data.DATA.resumenVentas.Efectivo,10)},a.resumenPorMayor={tarjeta:{total:parseFloat(e.data.DATA.resumenPorMayor.Tarjeta.total,10),pagos:e.data.DATA.resumenPorMayor.Tarjeta.pagos},transfVictor:{total:parseFloat(e.data.DATA.resumenPorMayor["Transf. Victor"].total,10),pagos:e.data.DATA.resumenPorMayor["Transf. Victor"].pagos},transfFede:{total:parseFloat(e.data.DATA.resumenPorMayor["Transf. Fede"].total,10),pagos:e.data.DATA.resumenPorMayor["Transf. Fede"].pagos},cheque:{total:parseFloat(e.data.DATA.resumenPorMayor.Cheque.total,10),pagos:e.data.DATA.resumenPorMayor.Cheque.pagos},efectivo:{total:parseFloat(e.data.DATA.resumenPorMayor.Efectivo.total,10),pagos:e.data.DATA.resumenPorMayor.Efectivo.pagos}},a.resumenGastos={tarjeta:parseFloat(e.data.DATA.resumenGastos.Tarjeta,10),debito:parseFloat(e.data.DATA.resumenGastos.Debito,10),cheque:parseFloat(e.data.DATA.resumenGastos.Cheque,10),efectivo:parseFloat(e.data.DATA.resumenGastos.Efectivo,10),transferencia:parseFloat(e.data.DATA.resumenGastos.Transferencia,10)}},function(){s.logout()})},a.loadDetalle=function(e){t.detalle(a.desde,a.hasta,e).then(function(t){switch(e){case"Efectivo":a.resumenPorMayor.efectivo.pagos=t.data.DATA;break;case"Tarjeta":a.resumenPorMayor.tarjeta.pagos=t.data.DATA;break;case"Cheque":a.resumenPorMayor.cheque.pagos=t.data.DATA;break;case"Tranf. Victor":a.resumenPorMayor.transfVictor.pagos=t.data.DATA;break;case"Tranf. Fede":a.resumenPorMayor.transfFede.pagos=t.data.DATA}},function(){})},a.cargar()}]);
app.controller("seguimientoCtrl",["$scope","$modal","productosService","AlertService","$filter",function(o,n,e){return o.alerts=[],o.p={mod_options:[]},o.movimientos=[],o.form={},o.form.idModelo="",o.form.modelo={nombre:"",id:""},hoy=formatLocalDate(),o.desde=hoy,o.hasta=hoy,o.search=function(){""!=o.form.idModelo&&e.getProductoModelo(o.form.idModelo).then(function(i){o.form.modelo=i.data.DATA},function(i){(403==i.status||401==i.status)&&($modalInstance.dismiss({action:"cancel"}),$location.path("/index")),o.form.modelo.nombre=""})},o.searchByName=function(){""!=o.form.modelo.nombre&&e.getProductoModeloByName(o.form.modelo.nombre).then(function(i){o.p.mod_options=i.data.DATA},function(){o.p.mod_options=[]})},o.setModel=function(i){o.form.modelo=i,o.form.idModelo=i.id},o.mostrarMovimientos=function(){o.parar=!1,o.movimientos=[],o.page=0,""!=o.form.idModelo&&o.cargar()},o.page=0,o.movimientos=[],o.parar=!1,o.pending=!1,o.cargar=function(){o.page++,o.pending=!0,e.movimientos(o.form.idModelo,o.desde,o.hasta,o.page).then(function(n){if(null!=n.data.DATA&n.data.DATA.movimientos.length>0)for(i=0;i<n.data.DATA.movimientos.length;i++)o.movimientos.push(n.data.DATA.movimientos[i]);else o.movimientos.length>0&&$(".finMovimientos").html('<div class="fin"></div>'),o.parar=!0;o.pending=!1},function(){o.pending=!1,o.parar=!0})},$("#infinite-scrolling").size()>0?void $(window).on("scroll",function(){$(window).scrollTop()>$(document).height()-$(window).height()-60&!o.parar&!o.pending&&o.movimientos.length>0&&o.cargar()}):void 0}]);
app.controller("usuariosCtrl",["$scope","$modal","$filter","$log","AlertService","usuariosService","$timeout",function(e,a,o,i,s,r){e.order="-nombre",e.nomPerfiles=["","Admin","Taller","Local","Cuentas"],listusuarios=function(a){e.data=a},r.usuarios(listusuarios),e.openUsuario=function(i){e.selectedUsuario=""!=i?o("getById")(e.data,i):"",angular.element("#nombre").focus();var t=a.open({templateUrl:dir_root+"/templates/usuarios/addedit.html",windowClass:"wndUsuarios",controller:"ModalUsuariosInstanceCtrl",backdrop:"static",keyboard:!0,resolve:{usuarios:function(){return e.selectedUsuario}}});t.result.then(function(a){""==e.selectedUsuario?r.addUsuario(a).then(function(a){e.data.push(a.data.DATA),s.add("success","El usuario fue creado",1e3)},function(e){var a=e.data.MSG;s.add("danger",a,5e3)}):r.editUsuario(a).then(function(){s.add("success","El usuario fue actualizado",1e3)},function(e){s.add("danger",e.data.MSG)})},function(i){if("delete"==i.action){var t={msj:"¿Está seguro que desea eliminar este usuario?",accept:"Si",cancel:"No"},n=i.idUsuario,u=a.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:"modalConfirmCtrl",resolve:{txt:function(){return t}}});u.result.then(function(){r.deleteUsuario(n).then(function(){var a=o("getIndexById")(e.data,n);e.data.splice(a,1)},function(e){s.add("danger",e.data.MSG)})},function(){})}})},e.nuevo=function(){e.openUsuario("")}}]),app.controller("ModalUsuariosInstanceCtrl",["$scope","$modalInstance","$filter","usuarios",function(e,a,o,i){if(""!=i){var s=angular.copy(i);e.usuarios=i}else{e.usuarios={nombre:"",clave:"",perfiles_id:"",perfil:""};var s=e.usuarios}e.perfiles=[{value:"1",text:"Admin"},{value:"3",text:"Local"},{value:"2",text:"Taller"},{value:"4",text:"Cuentas"}],e.ok=function(){a.close({usuarios:e.usuarios})},e.cancel=function(){e.back2original(),a.dismiss({action:"cancel"})},e.deleteUsuario=function(){e.back2original();var o={action:"delete",idUsuario:e.usuarios.id};a.dismiss(o)},e.back2original=function(){e.usuarios.nombre=s.nombre,e.usuarios.clave=s.clave,e.usuarios.perfiles_id=s.perfiles_id}}]);
app.controller("ventasCtrl",["$scope","$modal","ventasService","productosService","AlertService","$filter","$location",function(o,e,a,t,d,l){return o.alerts=[],o.order=["-created","-id"],fechaHoy=formatLocalDate(),o.filterVentas={filter:"hoy"},o.totalVentas=0,o.page=0,o.data=[],o.parar=!1,o.pending=!1,o.cargarVentas=function(){desde="hoy"==o.filterVentas.filter?fechaHoy:"",conDeuda="conDeuda"==o.filterVentas.filter?1:0,o.page++,o.pending=!0,a.ventas(desde,"",conDeuda,o.page).then(function(e){if(e.data.DATA.length>0){if(lastVenta=0==o.data.length?-1:o.data[o.data.length-1].id,firstNewVenta=e.data.DATA[0].id,lastVenta==firstNewVenta){for(j=0;j<e.data.DATA[0].modelos.length;j++)lastVenta=o.data[o.data.length-1].modelos.push(e.data.DATA[0].modelos[j]);n=1}else n=0;for(i=n;i<e.data.DATA.length;i++)o.data.push(e.data.DATA[i])}else o.data.length>0&&$(".finVentas").html('<div class="fin"></div>'),o.parar=!0;o.pending=!1},function(e){o.pending=!1,$route.reload(),d.add("danger",e.data.MSG,3e3)})},o.$watch("filterVentas.filter",function(e,a){e!=a&&(o.parar=!1,o.data=[],o.page=0,o.cargarVentas())},!0),o.infoModal={},o.openVenta=function(t,n){o.infoModal.venta=""!=t?l("getById")(o.data,t):"",o.infoModal.userRole=n,angular.element("#fechaVenta").focus();var i=e.open({templateUrl:dir_root+"/templates/ventas/addedit.html",windowClass:"wndVenta",controller:"ModalVentaInstanceCtrl",backdrop:"static",keyboard:!0,resolve:{info:function(){return o.infoModal}}});i.result.then(function(e){""==o.infoModal.venta?a.addVenta(e).then(function(e){o.data.splice(0,0,e.data.DATA),o.nuevo(n)},function(o){d.add("danger",o.data.MSG,5e3)}):a.editVenta(e).then(function(a){var t=l("getIndexById")(o.data,e.venta.id);o.data[t]=a.data.DATA,d.add("success",a.data.MSG,5e3)},function(o){d.add("danger",o.data.MSG,5e3)})},function(t){if("delete"==t.action){var n={msj:"¿Está seguro que desea eliminar esta venta?",accept:"Si",cancel:"No"},i=t.idVenta,r=e.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:"modalConfirmCtrl",resolve:{txt:function(){return n}}});r.result.then(function(){a.deleteVenta(i).then(function(){var e=l("getIndexById")(o.data,i);o.data.splice(e,1),d.add("success","Se eliminó la venta.",3e3)},function(o){d.add("danger",o.data.MSG,3e3)})},function(){})}})},o.nuevo=function(e){o.openVenta("",e)},o.showVenta=function(t,n){o.infoModal.venta=l("getById")(o.data,t),o.infoModal.userRole=n;var i=e.open({templateUrl:dir_root+"/templates/ventas/show.html",windowClass:"wndShowVenta",controller:"ModalVentaInstanceCtrl",backdrop:"static",keyboard:!0,resolve:{info:function(){return o.infoModal}}});i.result.then(function(){},function(t){if("delete"==t.action){var n={msj:"¿Está seguro que desea eliminar esta venta?",accept:"Si",cancel:"No"},i=t.idVenta,r=e.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:modalConfirmCtrl,resolve:{txt:function(){return n}}});r.result.then(function(){a.deleteVenta(i).then(function(){var e=l("getIndexById")(o.data,i);o.data.splice(e,1)},function(o){d.add("danger",o.data.MSG,5e3)})},function(){})}})},o.viewVenta=function(e,a,t){0==a?o.showVenta(e,t):o.openVenta(e,t)},o.openNotas=function(){angular.element("#nota").focus();e.open({templateUrl:dir_root+"/templates/ventas/notas.html",windowClass:"wndNotas",controller:"ModalNotaInstanceCtrl",backdrop:"static",keyboard:!0})},$("#infinite-scrolling").size()>0?void $(window).on("scroll",function(){$(window).scrollTop()>$(document).height()-$(window).height()-60&!o.parar&!o.pending&&o.cargarVentas()}):void 0}]),app.controller("ModalVentaInstanceCtrl",["$scope","$modalInstance","productosService","AlertService","ventasService","$filter","info","$location",function(o,e,a,t,n,d,l,r){if(o.fps=[{label:"Efectivo",value:"Efectivo"},{label:"Tarjeta",value:"Tarjeta"},{label:"Cheque",value:"Cheque"},{label:"Débito",value:"Debito"}],o.userRole=l.userRole,o.form={},o.p={},o.p.mod_options=[],o.p.dev_options=[],o.form.modelo={nombre:"",id:"",precio:""},o.form.modeloDev={nombre:"",id:"",precio:""},o.form.pago={monto:"",FP:"",created:formatLocalDate(),bonificacion:0},o.modId="",o.modName="",o.sumarPagos=function(){if(void 0!=o.venta.pagos){var e=0;for(i=0;i<o.venta.pagos.length;i++)e+=parseFloat(o.venta.pagos[i].monto,10)+parseFloat(o.venta.pagos[i].monto,10)*(parseInt(o.venta.pagos[i].bonificacion)/100);return e}},o.sumarDevoluciones=function(){if(void 0!=o.venta.devoluciones){var e=0;for(i=0;i<o.venta.devoluciones.length;i++)e+=parseFloat(o.venta.devoluciones[i].precio,10);return e}},""!=l.venta){o.venta=l.venta;var c=angular.copy(l.venta);o.venta.pagos=[],n.pagosVenta(l.venta.id).then(function(e){o.venta.pagos=e.data.DATA||[],o.venta.totalPagos=o.sumarPagos()},function(o){t.add("danger",o.data.MSG,5e3)}),o.venta.devoluciones=[],n.devolucionesVenta(l.venta.id).then(function(e){o.venta.devoluciones=e.data.DATA||[],o.venta.totalDevoluciones=o.sumarDevoluciones()},function(o){t.add("danger",o.data.MSG,5e3)})}else o.venta={created:formatLocalDate(),total:"0",nota:"",modelos:[],devoluciones:[],pagos:[],bonificacion:0,FP:null,totalPagos:0,totalDevoluciones:0,deuda:0,montoFavor:0,variosPagos:0};o.venta.mod2delete=[],o.venta.pagos2delete=[],o.venta.dev2delete=[],o.venta.variosPagos=o.venta.pagos.length>0||o.venta.deuda>0?1:0,o.back2original=function(){o.venta.created=c.created,o.venta.total=c.total,o.venta.totalDevoluciones=c.totalDevoluciones,o.venta.nota=c.nota,o.venta.FP=c.FP,o.venta.deuda=c.deuda,o.venta.montoFavor=c.montoFavor,o.venta.bonificacion=c.bonificacion,o.venta.modelos=c.modelos,o.venta.devoluciones=c.devoluciones,o.venta.mod2delete=[],o.venta.pagos2delete=[],o.venta.dev2delete=[]},o.ok=function(){1==o.venta.variosPagos&&(o.venta.FP=null),o.venta.deuda=o.venta.variosPagos*o.venta.deuda,e.close({venta:o.venta,action:""})},o.cancel=function(){void 0!=o.venta.id&&o.back2original(),e.dismiss({action:"cancel"})},o.deleteVenta=function(){e.dismiss({action:"delete",idVenta:o.venta.id})},o.search=function(){""!=o.form.idModelo&&a.getProductoModelo(o.form.idModelo).then(function(e){o.form.modelo=e.data.DATA},function(a){(403==a.status||401==a.status)&&(e.dismiss({action:"cancel"}),r.path("/index")),o.form.modelo.nombre=""})},o.searchByName=function(){""!=o.form.modelo.nombre&&a.getProductoModeloByName(o.form.modelo.nombre).then(function(e){o.p.mod_options=e.data.DATA},function(a){(403==a.status||401==a.status)&&(e.dismiss({action:"cancel"}),r.path("/index")),o.p.mod_options=[]})},o.setModel=function(e){o.form.modelo=e,o.form.idModelo=e.id},o.add=function(){void 0!=o.form.modelo.nombre&&void 0!=o.form.modelo.id&&""!=o.form.modelo.nombre&&""!=o.form.modelo.id&&(o.form.modelo.cantidad=o.form.modelo.cantidad||1,$mod={id:o.form.modelo.id,nombre:o.form.modelo.nombre,precio:o.form.modelo.precio,cantidad:1},o.venta.modelos.push($mod),o.venta.total=parseFloat(o.venta.total,10)+parseFloat(o.form.modelo.precio,10)*parseInt(o.form.modelo.cantidad,10),o.form.modelo={nombre:"",id:"",precio:"",cantidad:""},angular.element("#newModId").focus(),angular.element("#newMod").val(""),angular.element("#newModId").val(""))},o.remove=function(e){null!=o.venta.modelos[e].idVenMod&&o.venta.mod2delete.push({id:o.venta.modelos[e].idVenMod}),o.venta.total=parseFloat(o.venta.total,10)-parseFloat(o.venta.modelos[e].precio,10),o.venta.modelos.splice(e,1)},o.$watch("venta.bonificacion",function(){o.refreshTotal()}),o.$watch("venta.total",function(){o.refreshTotal()}),o.$watch("venta.montoFavor",function(){o.refreshTotal()}),o.$watch("venta.totalPagos",function(){o.refreshTotal()}),o.refreshTotal=function(){var e=""!=o.venta.montoFavor&&null!=o.venta.montoFavor?parseFloat(o.venta.montoFavor,10):0;o.venta.totalFinal=parseFloat(o.venta.total,10)-parseFloat(o.venta.totalDevoluciones,10)-e;var a=parseFloat(o.venta.totalFinal,10)*(parseFloat(o.venta.bonificacion,10)/100);o.venta.totalFinal=o.venta.totalFinal-a,void 0!=c&&0!=c.deuda?o.venta.deuda=o.venta.totalFinal-o.venta.totalPagos:void 0==c&&(o.venta.deuda=o.venta.totalFinal-o.venta.totalPagos)},o.searchDev=function(){""!=o.form.idModeloDev&&a.getProductoModelo(o.form.idModeloDev).then(function(e){o.form.modeloDev=e.data.DATA},function(a){(403==a.status||401==a.status)&&(e.dismiss({action:"cancel"}),r.path("/index")),o.form.modeloDev.nombre=""})},o.searchByNameDev=function(){""!=o.form.modeloDev.nombre&&a.getProductoModeloByName(o.form.modeloDev.nombre).then(function(e){o.p.dev_options=e.data.DATA},function(a){(403==a.status||401==a.status)&&(e.dismiss({action:"cancel"}),r.path("/index")),o.p.dev_options=[]})},o.setModelDev=function(e){o.form.modeloDev=e,o.form.idModeloDev=e.id},o.addDev=function(){void 0!=o.form.modeloDev.nombre&&void 0!=o.form.modeloDev.id&&""!=o.form.modeloDev.nombre&&""!=o.form.modeloDev.id&&($dev={id:o.form.modeloDev.id,nombre:o.form.modeloDev.nombre,precio:o.form.modeloDev.precio},o.venta.devoluciones.push($dev),o.venta.totalDevoluciones=parseFloat(o.venta.totalDevoluciones,10)+parseFloat(o.form.modeloDev.precio,10),o.form.modeloDev={nombre:"",id:"",precio:""},angular.element("#newDevId").focus(),angular.element("#newDev").val(""),angular.element("#newDevId").val(""))},o.removeDev=function(e){null!=o.venta.devoluciones[e].idDevMod&&o.venta.dev2delete.push({idDevMod:o.venta.devoluciones[e].idDevMod}),o.venta.totalDevoluciones=parseFloat(o.venta.totalDevoluciones,10)-parseFloat(o.venta.devoluciones[e].precio,10),o.venta.devoluciones.splice(e,1)},o.$watch("venta.totalDevoluciones",function(){o.refreshTotal()}),o.actualizarNota=function(){n.actualizarNota(o.venta.nota,o.venta.id).then(function(o){t.add("success",o.data.MSG,5e3)},function(o){t.add("danger",o.data.MSG)})},o.addPago=function(){""!=o.form.pago.monto&""!=o.form.pago.FP&&(o.form.pago.created=o.form.pago.created||formatLocalDate(),o.venta.pagos.push(o.form.pago),o.venta.totalPagos=parseFloat(o.venta.totalPagos)+parseFloat(o.form.pago.monto)+parseFloat(o.form.pago.monto)*(o.form.pago.bonificacion/100),angular.element("#montoPago").focus(),o.form.pago={monto:"",FP:"Efectivo",created:formatLocalDate(),bonificacion:0})},o.removePago=function(e){bonif=o.venta.pagos[e].monto*(o.venta.pagos[e].bonificacion/100),o.venta.totalPagos=parseInt(o.venta.totalPagos,10)-(parseInt(o.venta.pagos[e].monto,10)+bonif),null!=o.venta.pagos[e].id&&o.venta.pagos2delete.push({id:o.venta.pagos[e].id}),o.form.pago={monto:"",FP:"Efectivo",created:formatLocalDate(),bonificacion:0},o.venta.pagos.splice(e,1)},o.addPagoDefinitivo=function(){""!=o.form.pago.monto&""!=o.form.pago.FP&&n.addPago(o.form.pago,o.venta.id).then(function(e){o.form.pago.created=o.form.pago.created||formatLocalDate(),o.venta.pagos.push(e.data.DATA.pago),o.venta.totalPagos=parseFloat(o.venta.totalPagos)+parseFloat(o.form.pago.monto)+parseFloat(o.form.pago.monto)*(parseInt(o.form.pago.bonificacion)/100),o.form.pago={monto:"",FP:"Efectivo",created:formatLocalDate(),bonificacion:0},angular.element("#montoPago").focus()},function(o){t.add("danger",o.data.MSG)})},o.removePagoDefinitivo=function(e){null!=o.venta.pagos[e].id&&n.deletePago(o.venta.pagos[e].id).then(function(){o.venta.totalPagos=parseInt(o.venta.totalPagos,10)-(o.venta.pagos[e].monto+o.venta.pagos[e].monto*(o.venta.pagos[e].bonificacion/100)),o.form.pago={monto:"",FP:"Efectivo",created:formatLocalDate(),bonificacion:0},o.venta.pagos.splice(e,1)},function(o){t.add("danger",o.data.MSG)})}}]),app.controller("ModalNotaInstanceCtrl",["$scope","$modal","$modalInstance","notasService","AlertService",function(o,e,a,t,n){o.alerts=[],hoy=formatLocalDate(),o.nota={created:hoy,nota:""},t.notas(hoy,hoy).then(function(e){o.notas=e.data.DATA},function(o){n.add("danger",o.data.MSG)}),o.addNota=function(){""!=o.nota.nota&&(t.addNota(o.nota).then(function(e){o.notas.push(e.data.DATA)},function(o){n.add("danger",o.data.MSG)}),angular.element("#notaNota").focus(),angular.element("#notaNota").val(""))},o.removeNota=function(a){var d={msj:"¿Está seguro que desea eliminar esta nota?",accept:"Si",cancel:"No"},i=e.open({templateUrl:dir_root+"/templates/confirm.html",windowClass:"wndConfirm",controller:modalConfirmCtrl,resolve:{txt:function(){return d}}});i.result.then(function(){t.deleteNota(o.notas[a].id).then(function(){o.notas.splice(a,1)},function(o){n.add("danger",o.data.MSG)})},function(){})},o.salir=function(){a.close()}}]);